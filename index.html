<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Blood</title>
    <!-- Google Font: Hind Shiliguri -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display" rel="stylesheet">

    <style>
        /* General Styles */
        :root {
            --primary-color: #d32f2f;
        }

        body[data-theme="light"] {
           --secondary-color: #ffffff;
            --background-color: #f4f4f4;
            --dark-color: #333;
            --tet-color: #333;
            --light-gray: #f4f4f4;
            --medium-gray: #ccc;
            --card-background: #ffffff;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --input-border: #ccc;
            --input-background: #ffffff;
           --input-text: #333;
        }

       body[data-theme="dark"] {
            --secondary-color: #121212;
            --background-color: #121212;
            --dark-color: #e0e0e0;
            --text-color: #e0e0e0;
           --light-gray: #1e1e1e;
            --medium-gray: #444;
            --card-background: #1e1e1e;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.5);
            --input-border: #555;
            --input-background: #333;
            --input-ext: #e0e0e0;
        }
        @keyframes fadeIn {
           from { opacity: 0; }
           to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
       }

        @keyframes heart-pulse-3d {
            0%, 100% { transform: scale(1) rotateY(0deg); }
            50% { transform: scale(1.2) rotateY(20deg); }
        }
        
        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes ellipsis {
            0% { content: "."; }
            33% { content: ".."; }
            66% { content: "..."; }
        }
        
        @keyframes bell-shake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            92% { transform: rotate(1deg); }
            100% { transform: rotate(0); }
        }
        .shaking svg {
            animation: bell-shake 0.8s infinite;
        }

        @keyframes float-up {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                 opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        #animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: -1;
        }
        .blood-drop-animated {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: rgba(211, 47, 47, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            animation-name: float-up;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            will-change: transform;
        }


        body {
            font-family: 'Hind Siliguri', 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            padding: 1rem;
            max-width: 600px;
            margin: auto;
        }
        /* MODIFICATION: Reduce top gap on home page */
        #home-page .container {
            padding-top: 0.5rem;
        }

        /* Page/Screen Management */
        .page {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-in-out;
            padding-top: 60px; /* Space for header */
        }
        .page.active {
            display: block;
        }
        
        /* Header */
        .app-header {
            background-color: var(--primary-color);
            color: #ffffff;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .app-header .app-title {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .app-title-main {
             display: flex;
             align-items: center;
        }
        .app-title-main .header-heart {
            font-size: 1.2rem;
            margin: 0 8px;
            display: inline-block;
            animation: heart-pulse-3d 1.5s ease-in-out infinite;
        }
        .app-subtitle {
            font-size: 0.65rem; 
            font-weight: 400; 
            margin-top: 2px;
            letter-spacing: 0.5px;
        }

        .icon-button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.8rem;
            position: relative; 
        }
        #back-to-support-btn, #back-to-menu-btn {
            display: none; 
        }

        /* --- Notice Bar (MODIFIED) --- */
        .notice-bar {
            width: 100%;
            background-color: #fffbe6;
            color: #8a6d3b;
            z-index: 1;
            display: flex; 
            align-items: stretch; 
            border: 1px solid #ffeeba;
            border-radius: 8px;
            font-family: 'Hind Siliguri', sans-serif;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        body[data-theme="dark"] .notice-bar {
            background-color: #4d441a;
            color: #fdec9c;
            border-color: #856404;
        }
        .notice-label {
            display: flex;
            align-items: center;
            font-weight: 500; 
            white-space: nowrap; 
            padding: 4px 8px;
            background-color: #ffeeba; 
            color: #856404;
            font-size: 0.8rem;
        }
        body[data-theme="dark"] .notice-label {
            background-color: #856404;
            color: #fffbe6;
        }
        .notice-scroll-container {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
        }
        .scrolling-text {
            white-space: nowrap;
            position: absolute;
            margin: 0;
            padding-left: 10px;
            font-size: 0.9rem;
            animation: scroll-left 40s linear infinite; 
        }

        /* --- NEW: Banner Slider Styles --- */
        .banner-slider-container {
            width: 100%;
            aspect-ratio: 16 / 6;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            -webkit-user-select: none;
            user-select: none;
        }
        .banner-slides {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        .banner-slide {
            min-width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        .banner-slide a, .banner-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .banner-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .banner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.6s;
        }
        .banner-dot.active {
            background-color: #C0C0C0;
        }

        /* --- Notification Count Badge --- */
        #notification-count {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: #ffc107;
            color: black;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid white;
            display: none; 
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background-color: var(--card-background);
            z-index: 1001;
            transition: left 0.3s ease-in-out, background-color 0.3s;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            text-align: center;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto; 
            flex-grow: 1;
        }
        .sidebar-menu li a, .sidebar-menu li .dark-mode-toggle {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--text-color);
            border-bottom: 1px solid var(--medium-gray);
            transition: background-color 0.2s;
        }
        .sidebar-menu li a:hover {
            background-color: var(--background-color);
        }
        .sidebar-menu li a svg, .sidebar-menu li .dark-mode-toggle svg {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            fill: var(--primary-color);
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            cursor: pointer;
        }
        .dark-mode-toggle .switch {
            margin-left: auto;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }


        /* Overlay for Sidebar */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        #overlay.active {
            display: block;
        }

        /* Form Elements */
        .form-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-top: 0; /* Adjusted margin */
            transition: background-color 0.3s;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            background-color: var(--input-background);
            color: var(--input-text);
        }
        body[data-theme="dark"] .form-group input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .btn {
            display: inline-block;
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s;
            font-family: inherit; 
        }
        .btn:hover {
            background-color: #a72323;
        }
        .btn:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Modal (General) */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal.is-forced {
            pointer-events: all; 
            background-color: rgba(0,0,0,0.85); 
        }

        .modal-content {
            background-color: var(--card-background);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--medium-gray);
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .modal-content ul {
            padding-left: 20px;
        }
        .checkbox-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: left;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }


        /* Blocked User Modal Style */
        #blocked-user-modal .modal-content {
            text-align: center;
        }
        #blocked-user-modal .block-reason {
            background-color: #ffebee;
            border: 1px solid #e57373;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #333;
        }
        body[data-theme="dark"] #blocked-user-modal .block-reason {
            background-color: #4a1e1e;
            border-color: #e57373;
            color: #f7d1d1;
        }

        /* Donor Profile Cards */
        #donor-list {
            margin-top: 20px;
        }
        .donor-card {
            background-color: var(--card-background);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
        }
        .donor-card .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--background-color);
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .donor-card .avatar svg {
            width: 40px;
            height: 40px;
            fill: var(--primary-color);
        }
        .donor-card .info p {
            margin: 0 0 5px 0;
        }
        .donor-card .info .name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .donor-card .info .blood-group {
            font-weight: bold;
            color: var(--primary-color);
        }
        .donor-card .call-btn {
            margin-left: auto;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            flex-shrink: 0;
        }
        #no-donors-found {
            text-align: center;
            padding: 20px;
            background: var(--card-background);
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Notifications */
        .notification-panel {
            position: fixed;
            top: -100%;
            left: 0;
            right: 0;
            background-color: var(--card-background);
            z-index: 999;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: top 0.4s ease-in-out, background-color 0.3s;
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-panel.show {
            top: 55px;
        }
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--medium-gray);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Hind Siliguri', sans-serif;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-item small {
            display: block;
            color: #777;
            margin-top: 4px;
        }
        body[data-theme="dark"] .notification-item small { color: #aaa; }
        .delete-notification-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            margin-left: 10px;
        }
        .delete-notification-btn:hover {
            color: var(--text-color);
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: 20px;
            background: var(--card-background);
            margin-top: 20px;
            border-radius: 8px 8px 0 0;
        }
        .app-footer p {
            margin: 0 0 10px 0;
        }
        .social-links a {
            margin: 0 10px;
            text-decoration: none;
        }
        .social-links svg {
            width: 30px;
            height: 30px;
        }
        
        .developer-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px auto;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: block;
        }
        
        #terms-policy-page .form-card ul li {
            font-family: 'Hind Siliguri', sans-serif;
            margin-bottom: 8px; 
            font-size: 0.95rem; 
        }
        
        /* --- Gift Page Specific Styles --- */
        .payment-options {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .payment-option input[type="radio"] { display: none; }
        .payment-option label {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            width: 80px;
            font-weight: bold;
            color: white;
        }
        .payment-option label[for="bkash"] { background-color: #E736B5; }
        .payment-option label[for="nagad"] { background-color: #FF9633; }
        .payment-option label[for="rocket"] { background-color: #6C0E9A; }
        .payment-option label:hover { filter: brightness(1.1); }
        .payment-option input[type="radio"]:checked + label {
            border-color: var(--dark-color);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
            transform: scale(1.05);
        }
        .payment-logo { display: none; }
        
        .dev-number {
            font-size: 1.5rem; font-weight: bold; color: var(--primary-color);
            background-color: var(--background-color); padding: 10px; border-radius: 5px;
            margin: 15px 0 5px 0; border: 1px dashed var(--primary-color); user-select: all;
        }
        .close-modal-btn { margin-top: 15px; background-color: #7f8c8d; }

        /* NEW: Pre-gift modal checkbox styling */
        #pre-gift-modal .checkbox-group {
            justify-content: flex-start;
            text-align: left;
            font-size: 0.9rem;
        }
        #copy-message {
            font-size: 0.85rem;
            color: #27ae60;
            margin-top: 10px;
            font-weight: bold;
            display: none; /* Initially hidden */
        }
        
        /* --- Support Page --- */
        .support-option {
            display: flex; align-items: center; padding: 15px; margin-bottom: 10px;
            border-radius: 8px; background-color: var(--light-gray); border: 1px solid var(--medium-gray);
            cursor: pointer; text-decoration: none; color: var(--text-color);
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .support-option:hover { background-color: var(--background-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .support-option svg { width: 24px; height: 24px; margin-right: 15px; fill: var(--primary-color); }
        .support-option .text h3 { margin: 0 0 5px 0; }
        .support-option .text p { margin: 0; font-size: 0.9rem; color: #666; }
        body[data-theme="dark"] .support-option .text p { color: #aaa; }
        
        /* --- Support Chat Page --- */
        .chat-container {
            display: flex; flex-direction: column; height: calc(100vh - 120px);
            background-color: var(--card-background); border-radius: 8px; box-shadow: var(--card-shadow); overflow: hidden;
        }
        .chat-messages {
            flex-grow: 1; padding: 15px; overflow-y: auto; display: flex;
            flex-direction: column; background-color: var(--background-color);
        }
        .message {
            max-width: 85%; padding: 10px 15px; border-radius: 18px;
            margin-bottom: 10px; line-height: 1.4; position: relative;
        }
        /* MODIFIED: Chat bot message background */
        .message.bot { 
            background-color: #e0e0e0; /* Ash color for light mode */
            color: #000000; 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
        }
        body[data-theme="dark"] .message.bot {
            background-color: #424242; /* Darker ash for dark mode */
            color: var(--text-color);
        }
        .message.user { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message .sender-name { display: block; font-size: 0.75rem; font-weight: bold; color: #555; margin-bottom: 4px; }
        body[data-theme="dark"] .message .sender-name { color: #bbb; }
        .message.user .sender-name { display: none; }
        
        .chat-event-message {
            align-self: center;
            background-color: #e0e0e0;
            color: #616161;
            font-size: 0.75rem;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 8px 0;
            text-align: center;
        }
        body[data-theme="dark"] .chat-event-message {
            background-color: #424242;
            color: #bdbdbd;
        }
        .chat-event-message .connecting-status {
            font-size: 0.7rem;
            color: #757575;
            margin-top: 3px;
            font-style: italic;
        }
        body[data-theme="dark"] .chat-event-message .connecting-status { color: #aeaeae; }
        .chat-event-message .connecting-status::after {
            display: inline-block;
            animation: ellipsis 1.25s infinite;
            content: ".";
            width: 1em;
            text-align: left;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: var(--light-gray);
            color: #888;
            font-style: italic;
            padding: 8px 15px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .typing-indicator span {
            display: inline-block;
            animation: ellipsis 1.5s infinite;
            width: 1.5em;
            text-align: left;
        }

        .chat-input-area { display: flex; flex-direction: column; border-top: 1px solid var(--medium-gray); background-color: var(--card-background); }
        .chat-input-wrapper { display: flex; width: 100%; padding: 10px; box-sizing: border-box; }
        .chat-input-area input[type="text"], .chat-input-area input[type="password"], .chat-input-area input[type="tel"], .chat-input-area input[type="date"], .chat-input-area input[type="number"] {
            flex-grow: 1; border: 1px solid var(--input-border); background-color: var(--input-background); color: var(--input-text); border-radius: 20px; padding: 10px 15px; margin-right: 10px;
        }
        .chat-input-area button {
            border-radius: 50%; width: 45px; height: 45px; border: none; background-color: var(--primary-color);
            color: white; cursor: pointer; flex-shrink: 0;
        }
        .chat-input-area input:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
        }
        .chat-input-area button:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .quick-replies {
            display: flex; flex-wrap: wrap; padding: 5px 10px 10px 10px;
            justify-content: flex-start; border-top: 1px solid var(--medium-gray); background-color: var(--card-background);
        }
        .quick-reply {
            padding: 8px 15px; border: 1px solid var(--primary-color); color: var(--primary-color);
            background-color: var(--card-background); border-radius: 20px; cursor: pointer; margin: 5px;
            font-size: 0.9rem; transition: background-color 0.2s, color 0.2s;
        }
        .quick-reply:hover { background-color: var(--primary-color); color: white; }
        .quick-reply.back-btn { background-color: #7f8c8d; border-color: #7f8c8d; color: white; }
        
        .chat-form-compact {
            padding: 10px 15px; margin: 0; border-radius: 8px; background-color: transparent;
        }
        .chat-form-compact .form-group { margin-bottom: 8px; }
        .chat-form-compact label { font-size: 0.8rem; margin-bottom: 3px; }
        .chat-form-compact input, .chat-form-compact select, .chat-form-compact textarea {
            padding: 8px; font-size: 0.85rem; width: 100%; box-sizing: border-box;
        }
        .chat-form-compact .form-actions { display: flex; gap: 8px; margin-top: 10px; }
        .chat-form-compact .form-actions .btn {
            width: 100%; flex: 1; padding: 8px; font-size: 0.9rem; border-radius: 8px;
        }
        .chat-form-compact .form-actions .btn-cancel { background: #95a5a6; }
        .chat-form-compact a.chat-form-link { font-size: 0.8rem; text-align: center; display: block; margin-top: 10px; cursor: pointer; color: var(--primary-color); }
        .btn-submit-special {
            background: linear-gradient(45deg, #28a745, #2ecc71);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .donation-form-wrapper .payment-option label {
            width: 80px;
            padding: 8px;
            font-weight: bold;
            color: white;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .donation-form-wrapper .payment-option label[for="chat-bkash"] { background-color: #E736B5; }
        .donation-form-wrapper .payment-option label[for="chat-nagad"] { background-color: #FF9633; }
        .donation-form-wrapper .payment-option label[for="chat-rocket"] { background-color: #6C0E9A; }
        .donation-form-wrapper .payment-option input[type="radio"]:checked + label {
            border-color: var(--dark-color);
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        /* NEW: Styles for chat donation form */
        .chat-donation-steps .checkbox-group {
            justify-content: flex-start;
            font-size: 0.85rem;
        }
        .chat-donation-steps .copy-message {
            font-size: 0.8rem;
            color: #27ae60;
            margin: 5px 0;
            font-weight: bold;
            display: none;
        }


        /* --- Chat Rating Styles --- */
        .chat-rating-area { padding: 15px; text-align: center; border-top: 1px solid var(--medium-gray); background-color: var(--card-background); }
        .rating-stars { font-size: 2.5rem; color: #ddd; cursor: pointer; }
        body[data-theme="dark"] .rating-stars { color: #555; }
        .rating-stars .star { transition: color 0.2s; }
        .rating-stars .star:hover, .rating-stars .star.hovered { color: #f39c12; }
        .rating-stars .star.selected { color: #f1c40f; }
        .rating-emoji { font-size: 3rem; margin-top: 10px; height: 50px; }
        
        /* NEW: Social Join Modal Styles */
        #social-join-modal .modal-content {
            max-width: 380px;
            border-top: 5px solid var(--primary-color);
        }
        #social-join-modal .social-channel-link {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            background-color: var(--light-gray);
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        #social-join-modal .social-channel-link:hover {
            background-color: var(--background-color);
        }
        #social-join-modal .social-channel-link svg {
            width: 32px;
            height: 32px;
            margin-right: 15px;
        }
        #social-join-modal .social-channel-link .channel-name {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* --- START: MODIFIED SOCIAL FEED STYLES --- */
        #social-feed-page {
            position: fixed;
            top: 0;
            right: -100%; /* Initially off-screen */
            width: 100%;
            height: 100%;
            background-color: var(--background-color);
            z-index: 1002; /* Above sidebar */
            transition: right 0.4s ease-in-out;
            padding-top: 0; /* MODIFICATION: Removed padding for new header */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #social-feed-page.active {
            right: 0; /* Slide in */
        }
        
        /* NEW: Feed Header Styles */
        .feed-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--medium-gray);
            flex-shrink: 0;
        }
        .feed-header .icon-button {
            color: var(--text-color); /* Match theme color */
            font-size: 1.5rem;
        }
        .feed-title {
            flex-grow: 1;
            text-align: center;
            line-height: 1.2;
        }
        .feed-title-main {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        .feed-subtitle {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        #social-feed-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            max-width: 500px; /* Instagram-like width */
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .post-card {
            background-color: var(--card-background);
            border: 1px solid var(--medium-gray);
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }
        .post-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        .post-header-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--light-gray);
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .post-header-avatar svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
        }
        .post-header-info .name {
            font-weight: 600;
        }
        .post-header-info .id {
            font-size: 0.75rem;
            color: #888;
        }
        body[data-theme="dark"] .post-header-info .id {
            color: #aaa;
        }

        .post-image-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: var(--light-gray);
            position: relative; /* NEW: For watermark positioning */
        }
        .post-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* NEW: Watermark Style */
        .post-image-container::after {
            content: 'My Blood';
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.6);
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 500;
            border-radius: 3px;
            opacity: 0.8;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        body[data-theme="dark"] .post-image-container::after {
            background-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.5);
        }

        .post-actions {
            display: flex;
            align-items: center;
            padding: 8px 15px;
        }
        .like-btn, .share-btn { /* MODIFICATION: Grouped common styles */
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .like-btn svg, .share-btn svg { /* MODIFICATION: Grouped common styles */
            width: 28px;
            height: 28px;
            fill: var(--text-color);
            transition: transform 0.2s ease, fill 0.2s;
        }
        .like-btn.liked svg {
            fill: #ff3040;
        }
        .like-btn:active, .share-btn:active { /* MODIFICATION: Grouped common styles */
            transform: scale(1.2);
        }
        .share-btn {
            margin-left: 8px; /* NEW: Space between like and share */
        }
        .like-count {
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .post-caption {
            padding: 0 15px 15px 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .post-caption .uploader-name {
            font-weight: 600;
            margin-right: 5px;
        }
        .post-caption .post-short-id {
            color: #00376b;
            font-weight: 500;
            display: block;
            margin-top: 5px;
        }
        body[data-theme="dark"] .post-caption .post-short-id {
            color: #8ab4f8;
        }
        #no-posts-found {
            text-align: center;
            padding: 50px 20px;
            color: #888;
        }
        /* --- END: MODIFIED SOCIAL FEED STYLES --- */


        @media (max-width: 480px) {
            .donor-card { padding: 10px; margin-bottom: 10px; }
            .donor-card .avatar { width: 50px; height: 50px; margin-right: 12px; }
            .donor-card .avatar svg { width: 30px; height: 30px; }
            .donor-card .info { line-height: 1.3; }
            .donor-card .info p { font-size: 0.85rem; margin-bottom: 3px; }
            .donor-card .info .name { font-size: 1rem; }
            .donor-card .call-btn { padding: 8px 10px; font-size: 0.8rem; }
        }

    </style>
</head>
<body>
    
    <div id="animated-background"></div>

    <!-- Main App Structure -->
    <div id="app">

        <!-- Header -->
        <header class="app-header">
            <button class="icon-button" id="menu-toggle-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
            <button class="icon-button" id="back-to-menu-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <button class="icon-button" id="back-to-support-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>

            <div class="app-title">
                <div class="app-title-main">
                    <span class="header-heart">❤️‍🔥</span>
                    <span>My Blood</span>
                    <span class="header-heart">❤️‍🔥</span>
                </div>
                <div class="app-subtitle">রক্ত খুঁজুন - রক্ত দান করুন</div>
            </div>
            <button class="icon-button" id="notification-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                <span id="notification-count"></span>
            </button>
        </header>

        <div id="notification-panel" class="notification-panel">
             <div id="notification-list">You have no notifications</div>
        </div>
        
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">My Blood Menu</div>
            <ul class="sidebar-menu">
                <li><a href="#" class="nav-link" data-page="home">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>
                    Home</a></li>
                <li class="logged-out"><a href="#" class="nav-link" data-page="register">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 8c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4zm-6 4c.22-.72 3.31-2 6-2 2.7 0 5.8 1.29 6 2H9zm-3-3v-3h3v-2H6V7H4v3H1v2h3v3h2z"/></svg>
                    Register as a Donor</a></li>
                <!-- MODIFIED: DonorBook Menu Item Added -->
                <li><a href="#" class="nav-link" data-page="donorbook">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    DonorBook</a></li>
                <li class="logged-out"><a href="#" class="nav-link" data-page="login">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/></svg>
                    Login</a></li>
                 <li class="logged-in" style="display:none;"><a href="#" class="nav-link" data-page="account">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    Your Account</a></li>
                <li><a href="#" class="nav-link" data-page="support">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V4c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
                    Support</a></li>
                <li><a href="#" class="nav-link" data-page="complain">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27L15.73 3zM12 17.3c-.72 0-1.3-.58-1.3-1.3 0-.72.58-1.3 1.3-1.3s1.3.58 1.3 1.3c0 .72-.58 1.3-1.3 1.3zm1-4.3h-2V7h2v6z"/></svg>
                    Complain Donor</a></li>
                <li><a href="#" class="nav-link" data-page="feedback">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12zM7 9h10v2H7zm-2 4h7v2H5z"/></svg>
                    Give Feedback</a></li>
                <li><a href="#" id="gift-link">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35C11.96 2.54 11.05 2 10 2c-1.66 0-3 1.34-3 3 0 .35.07.69.18 1H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 16H4V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h4v12z"/></svg>
                    <span>Gift To My Blood Developer</span></a></li>
                <li>
                    <div class="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9.37 5.51C9.19 6.15 9.1 6.82 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49zM12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                        <span>Dark Mode</span>
                        <label class="switch">
                            <input type="checkbox" id="dark-mode-switch">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </li>
                <li><a href="#" class="nav-link" data-page="social-platform">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    Our Social Platform</a></li>
                <li><a href="#" class="nav-link" data-page="terms-policy">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-5h2v2h-2zm0-8h2v6h-2z"/></svg>
                    Terms And Policy</a></li>
                <li><a href="#" class="nav-link" data-page="about">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                    About Us</a></li>
                <li class="logged-in" style="display:none;"><a href="#" id="logout-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                    Logout</a></li>
            </ul>
        </div>
        <div id="overlay"></div>

        <!-- Home Page (Donor Search) -->
        <div id="home-page" class="page active">
            <div class="container">
                <!-- Notice Bar is now inside the scrollable container -->
                <div id="notice-bar-container" class="notice-bar" style="display: none;">
                     <span class="notice-label">
                        <span>দৃষ্টি আকর্ষণ:</span>
                     </span>
                     <div class="notice-scroll-container">
                        <p id="notice-bar-text" class="scrolling-text"></p>
                     </div>
                </div>

                <!-- NEW: Banner Slider -->
                <div id="banner-slider-container" class="banner-slider-container" style="display: none;">
                    <div class="banner-slides">
                        <!-- Slides will be injected by JavaScript -->
                    </div>
                    <div class="banner-dots">
                        <!-- Dots will be injected by JavaScript -->
                    </div>
                </div>

                <div class="form-card">
                    <h2>Search Donor</h2>
                    <form id="search-donor-form">
                        <div class="form-group">
                            <label for="search-blood-group">Blood Group</label>
                            <select id="search-blood-group" required>
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option> <option value="A-">A-</option>
                                <option value="B+">B+</option> <option value="B-">B-</option>
                                <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                <option value="O+">O+</option> <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-district">District</label>
                            <select id="search-district" required></select>
                        </div>
                        <div id="search-thana-container" style="display: none; margin-top: 15px;">
                            <div class="checkbox-group" style="justify-content: flex-start;">
                                <input type="checkbox" id="search-by-thana-checkbox">
                                <label for="search-by-thana-checkbox">নিকটবর্তী থানায় ডোনার খুঁজুন</label>
                            </div>
                            <div class="form-group" id="search-thana-group" style="display: none; margin-top: 10px;">
                                <label for="search-thana">Thana</label>
                                <select id="search-thana"></select>
                            </div>
                        </div>
                        <button type="submit" class="btn">Search</button>
                    </form>
                </div>
                <div id="donor-list"></div>
            </div>
        </div>
        
        <!-- Register Page -->
        <div id="register-page" class="page">
            <div class="container">
                 <div class="form-card">
                    <h2>Register as a Donor</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="reg-name">Name (in English)</label>
                            <input type="text" id="reg-name" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-mobile">Mobile</label>
                            <input type="tel" id="reg-mobile" required pattern="01[3-9][0-9]{8}" title="Please enter a valid 11-digit mobile number.">
                        </div>
                        <div class="form-group">
                            <label for="reg-blood-group">Blood Group</label>
                            <select id="reg-blood-group" required>
                                 <option value="">Select Blood Group</option>
                                 <option value="A+">A+</option> <option value="A-">A-</option>
                                 <option value="B+">B+</option> <option value="B-">B-</option>
                                 <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                 <option value="O+">O+</option> <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gender</label><br>
                            <input type="radio" id="male" name="gender" value="Male" checked> <label for="male">Male</label>
                            <input type="radio" id="female" name="gender" value="Female"> <label for="female">Female</label>
                        </div>
                        <div class="form-group">
                            <label for="reg-district">District</label>
                            <select id="reg-district" required></select>
                        </div>
                        <div class="form-group" id="reg-thana-group" style="display: none;">
                            <label for="reg-thana">Thana</label>
                            <select id="reg-thana" required></select>
                        </div>
                        <div class="form-group">
                            <label for="last-donation">Last Donation Date</label>
                            <input type="date" id="last-donation">
                            <div class="checkbox-group" style="margin-top:10px; justify-content: flex-start;">
                                <input type="checkbox" id="no-donated">
                                <label for="no-donated">I have not donated before.</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="reg-total-donations">মোট রক্তদান (সংখ্যায়)</label>
                            <input type="number" id="reg-total-donations" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="reg-password">Set Password (min. 5 characters)</label>
                            <input type="password" id="reg-password" required minlength="5">
                        </div>
                        <button type="submit" class="btn">Register</button>
                    </form>
                 </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>Login</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-id">Mobile Number or User ID</label>
                            <input type="text" id="login-id" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <button type="submit" class="btn">Login</button>
                        <a href="#" id="forgot-password-link" style="display:block; text-align:center; margin-top:10px;">Forgot Password?</a>
                    </form>
                </div>
            </div>
        </div>

        <!-- Forgot Password Page -->
        <div id="forgot-password-page" class="page">
             <div class="container">
                <div class="form-card">
                    <h2>Forgot Password</h2>
                    <form id="forgot-password-form">
                        <div class="form-group">
                            <label for="fp-mobile">Your Mobile Number</label>
                            <input type="tel" id="fp-mobile" required pattern="01[3-9][0-9]{8}">
                        </div>
                        <div class="form-group">
                            <label for="fp-last-three">Last 3 Characters of Old Password</label>
                            <input type="text" id="fp-last-three" required maxlength="3">
                        </div>
                        <button type="submit" class="btn">Verify</button>
                    </form>
                     <form id="reset-password-form" style="display:none;">
                        <p>Verification Successful! Set a new password.</p>
                        <div class="form-group">
                            <label for="fp-new-password">New Password</label>
                            <input type="password" id="fp-new-password" required minlength="5">
                        </div>
                        <button type="submit" class="btn">Set New Password</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Account Page -->
        <div id="account-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>Your Account</h2>
                    <form id="account-form">
                        <div class="form-group">
                            <label>User ID</label>
                            <input type="text" id="acc-userid" readonly>
                        </div>
                         <div class="form-group">
                            <label for="acc-name">Name</label>
                            <input type="text" id="acc-name" required>
                        </div>
                        <div class="form-group">
                            <label for="acc-mobile">Mobile</label>
                            <input type="tel" id="acc-mobile" readonly>
                        </div>
                        <div class="form-group">
                            <label for="acc-blood-group">Blood Group</label>
                            <select id="acc-blood-group" required></select>
                        </div>
                         <div class="form-group">
                            <label>Gender</label><br>
                            <input type="radio" id="acc-male" name="acc-gender" value="Male"> <label for="acc-male">Male</label>
                            <input type="radio" id="acc-female" name="acc-gender" value="Female"> <label for="acc-female">Female</label>
                        </div>
                        <div class="form-group">
                            <label for="acc-district">District</label>
                            <select id="acc-district" required></select>
                        </div>
                        <div class="form-group" id="acc-thana-group" style="display: none;">
                            <label for="acc-thana">Thana</label>
                            <select id="acc-thana" required></select>
                        </div>
                        <div class="form-group">
                            <label for="acc-last-donation">Update Last Donation Date</label>
                            <input type="date" id="acc-last-donation">
                        </div>
                        <div class="form-group">
                            <label for="acc-total-donations">মোট রক্তদান (সংখ্যায়)</label>
                            <input type="number" id="acc-total-donations" min="0" placeholder="0">
                        </div>
                        <button type="submit" class="btn">Update Profile</button>
                    </form>
                    <button id="delete-account-btn" class="btn" style="background-color:#c0392b; margin-top:15px;">Delete Account</button>
                </div>
            </div>
        </div>

        <!-- Gift Page -->
        <div id="gift-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>অ্যাপ উন্নতি বা ডেভেলপার কে হাদিয়া পাঠানোর জন্য ধন্যবাদ!</h2>
                    <p>দয়া করে নিচের তথ্যগুলো পূরণ করুন।</p>
                    <form id="gift-form">
                        <div class="form-group">
                            <label for="gift-name">আপনার নাম</label>
                            <input type="text" id="gift-name" required>
                        </div>
                        <div class="form-group">
                            <label for="gift-mobile">আপনার মোবাইল</label>
                            <div class="input-with-prefix">
                                <span class="prefix">+88</span>
                                <input type="tel" id="gift-mobile" required pattern="01[3-9][0-9]{8}" title="Please enter a valid 11-digit mobile number." placeholder="01xxxxxxxxx">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="gift-address">আপনার ঠিকানা</label>
                            <input type="text" id="gift-address" required>
                        </div>
                        <div class="form-group">
                            <label for="gift-reason">উপহারের কারণ</label>
                            <textarea id="gift-reason" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="gift-amount">Amount</label>
                            <input type="text" id="gift-amount" inputmode="numeric" pattern="[0-9]*" required placeholder="শুধুমাত্র ইংরেজি সংখ্যায় লিখুন">
                        </div>
                        <div class="form-group">
                            <label>যে মাধ্যমে পাঠাতে চান</label>
                            <div class="payment-options">
                                <div class="payment-option">
                                    <input type="radio" id="bkash" name="payment_method" value="bKash" checked>
                                    <label for="bkash">
                                        <span>বিকাশ</span>
                                    </label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="nagad" name="payment_method" value="Nagad">
                                    <label for="nagad">
                                        <span>নগদ</span>
                                    </label>
                                </div>
                                <div class="payment-option">
                                    <input type="radio" id="rocket" name="payment_method" value="Rocket">
                                    <label for="rocket">
                                        <span>রকেট</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="gift-trx-digits">যে একাউন্ট থেকে হাদিয়া দিতে চান তার শেষ ৩ সংখ্যা</label>
                            <input type="text" id="gift-trx-digits" required maxlength="3" pattern="[0-9]{3}">
                        </div>
                        
                        <button type="submit" class="btn" style="background-color: #27ae60;">Submit Information</button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Complain Page -->
        <div id="complain-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>অভিযোগ জমা দিন (Complain Donor)</h2>
                    <form id="complain-form">
                        <div class="form-group">
                            <label for="complainant-name">অভিযোগকারীর নাম</label>
                            <input type="text" id="complainant-name" required>
                        </div>
                        <div class="form-group">
                            <label for="complainant-mobile">অভিযোগকারীর মোবাইল নাম্বার</label>
                            <input type="tel" id="complainant-mobile" required pattern="01[3-9][0-9]{8}">
                        </div>
                        <div class="form-group">
                            <label for="donor-name">অভিযোগকৃত ডোনারের নাম</label>
                            <input type="text" id="donor-name" required>
                        </div>
                        <div class="form-group">
                            <label for="donor-mobile">অভিযোগকৃত ডোনারের নাম্বার</label>
                            <input type="tel" id="donor-mobile" required pattern="01[3-9][0-9]{8}">
                        </div>
                        <div class="form-group">
                            <label for="complain-description">অভিযোগের কারণ বর্ণনা করুন</label>
                            <textarea id="complain-description" rows="4" required></textarea>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="complain-oath">
                            <label for="complain-oath">আমি আল্লাহর নামে শপথ করে বলছি যে, আমার প্রদত্ত সকল তথ্য ও অভিযোগ সত্য।</label>
                        </div>
                        <button type="submit" id="complain-submit-btn" class="btn" disabled>সাবমিট করুন</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Other Pages -->
         <div id="support-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>Support</h2>
                    <p>আপনার যেকোনো প্রয়োজনে আমাদের সাথে যোগাযোগ করুন।</p>
                    <a href="mailto:team.myblood@gmail.com" class="support-option">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6zm-2 0l-8 5-8-5h16zm0 12H4V8l8 5 8-5v10z"/></svg>
                        <div class="text">
                            <h3>Email</h3>
                            <p>সরাসরি আমাদের ইমেইল করুন।</p>
                        </div>
                    </a>
                    <a href="#" class="support-option" id="live-chat-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V4c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/></svg>
                        <div class="text">
                            <h3>Live Chat</h3>
                            <p>আমাদের প্রতিনিধির সাথে কথা বলুন।</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="feedback-page" class="page">
            <div class="container">
                 <div class="form-card">
                    <h2>Give Feedback</h2>
                    <form id="feedback-form">
                        <div class="form-group">
                            <label for="feedback-name">নাম</label>
                            <input type="text" id="feedback-name" required>
                        </div>
                        <div class="form-group">
                            <label for="feedback-mobile">১১ ডিজিট মোবাইল নাম্বার</label>
                            <input type="tel" id="feedback-mobile" required placeholder="শুধুমাত্র ইংরেজি সংখ্যায় লিখুন">
                        </div>
                         <div class="form-group">
                            <label for="feedback-email">ইমেইল</label>
                            <input type="email" id="feedback-email" required>
                        </div>
                        <div class="form-group">
                            <label for="feedback-text">Your Opinion</label>
                            <textarea id="feedback-text" rows="5" required></textarea>
                        </div>
                        <button type="submit" id="feedback-submit-btn" class="btn" disabled>Submit</button>
                    </form>
                 </div>
            </div>
        </div>
        <div id="about-page" class="page">
            <div class="container">
                 <div class="form-card">
                    <h2>About Us</h2>
                    <p>"My Blood" was created for service. In our country, a lot of blood is needed in an emergency. Many times it is seen that even if it is needed, no donor can be found. Or you have to go from door to door to find many people, make calls. So Abdus Samad created this application to make it easy for people to find their required blood donor easily.</p>
                 </div>
                 <div class="app-footer">
                    <img src="https://i.postimg.cc/zGTNPqBv/IMG-20250928-140332.jpg" alt="Developer Abdus Samad" class="developer-img">
                    <p>This Software Developed by Abdus Samad</p>
                    <div class="social-links">
                        <a href="https://www.facebook.com/a.samad63" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#1877F2"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></a>
                        <a href="mailto:team.myblood@gmail.com"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#DB4437"><path d="M496 80V432c0 8.8-7.2 16-16 16H32c-8.8 0-16-7.2-16-16V80c0-8.8 7.2-16 16-16H480c8.8 0 16 7.2 16 16zM256 251.1L399.7 149.6c-4.3-1.2-8.8-1.6-13.7-1.6H126c-5 0-9.6 .5-14 1.7L256 251.1zM112 192.3V384h288V192.3L256 295.1 112 192.3z"/></svg></a>
                        <a href="https://www.tiktok.com/@team.tawhaa.official?_t=ZS-9005Q90FYfo&_r=1" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#000000"><path d="M448,209.91a210.06,210.06,0,0,1-122.77-39.25V349.38A162.55,162.55,0,1,1,185,188.31V278.2a74.62,74.62,0,1,0,52.23,71.18V0l88,0a121.18,121.18,0,0,0,1.86,22.17h0A122.18,122.18,0,0,0,381,102.39a121.43,121.43,0,0,0,67,20.14Z"/></svg></a>
                    </div>
                </div>
            </div>
        </div>

        <div id="terms-policy-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>Terms And Policy</h2>
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li>* আল্লাহর সন্তুষ্টির উদ্দেশ্য রক্ত দান করবেন।</li>
                        <li>* ডোনার কে সালামের সহিত যথাযথ সম্মান দিয়ে কথা বলতে হবে।</li>
                        <li>* My Blood এপ্লিকেশন থেকে ডোনারকে কল দিলে অবশ্যই বলতে হবে 'আমি My Blood অ্যাপ্লিকেশন থেকে আপনার নাম্বার পেয়েছি'।</li>
                        <li>* ডোনার কে অবশ্যই রক্তদান শেষে তার আসা যাওয়ার যাবতীয় খরচ বহন করবেন।</li>
                        <li>* ডোনার কে হাদিয়া দেওয়ার চেষ্টা করবেন। যদি ডোনার গ্রহণ না করেন তাহলে সমস্যা নেই।</li>
                        <li>* অবশ্যই রক্তদানের পর ডোনার কে ভালো ভাবে খাওয়াবেন।</li>
                        <li>* রক্তদানের পর অবশ্যই ডোনারকে My Blood অ্যাপ্লিকেশনে লাস্ট ডোনেশন আপডেট করতে বলবেন।</li>
                        <li>* My Blood অ্যাপ্লিকেশনের ডোনারদের নিজের কোনো রক্তদান সংস্থার নামে চালাবেন না। অন্যথায় My Blood কর্তৃপক্ষ যেকোনো আইনানুগ ব্যবস্থা নেওয়ার অধিকার রাখে।</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div id="social-platform-page" class="page">
            <div class="container">
                <div class="form-card">
                    <h2>Our Social Platform</h2>
                    <p>আমাদের সাথে যুক্ত হতে নিচের প্ল্যাটফর্মগুলোতে যোগ দিন।</p>
                    
                    <a href="https://www.facebook.com/share/14HLFKVuou2/" class="support-option" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#1877F2"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
                        <div class="text">
                            <h3>Facebook Page</h3>
                        </div>
                    </a>

                    <a href="https://www.facebook.com/groups/932867320420701/?ref=share&mibextid=NSMWBT" class="support-option" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="#1877F2"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
                        <div class="text">
                            <h3>Facebook Group</h3>
                        </div>
                    </a>

                    <a href="https://t.me/TeamTawHaaOFC" class="support-option" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" fill="#2AABEE"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142.3 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4.2 20.8 2.7 17.2 15.1z"/></svg>
                        <div class="text">
                            <h3>Telegram Channel</h3>
                        </div>
                    </a>
                    
                    <a href="https://s.channelcom.tech/4kionk?from=copy_link" class="support-option" target="_blank" rel="noopener noreferrer">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#8A3DA2"><path d="M224 448.1c-112.9 0-204.8-89.4-204.8-199.2S111.1 49.7 224 49.7s204.8 89.4 204.8 199.2-91.9 199.2-204.8 199.2zM337 198.8c-6.8 0-12.3 5.5-12.3 12.3s5.5 12.3 12.3 12.3 12.3-5.5 12.3-12.3-5.5-12.3-12.3-12.3zm-78.4 0c-6.8 0-12.3 5.5-12.3 12.3s5.5 12.3 12.3 12.3 12.3-5.5 12.3-12.3-5.5-12.3-12.3-12.3zm-78.3 0c-6.8 0-12.3 5.5-12.3 12.3s5.5 12.3 12.3 12.3c6.8 0 12.3-5.5 12.3-12.3s-5.5-12.3-12.3-12.3zm182.2 69.3c-23-4.5-55.9-10.8-55.9-32.9 0-23.7 13-43.1 39.4-43.1 11.2 0 25.1 4.5 38.1 11.8l11.2-30.8c-14.3-6.8-31.5-10.8-49.3-10.8-44.5 0-79.5 28.3-79.5 72.1 0 35.8 40.2 49.3 64.8 54.7 26.3 5.6 50.5 13 50.5 35.4.1 22.1-15.9 38.5-40.6 38.5-16.3 0-33.7-5.2-49.3-14.3l-11.2 31.2c16.3 8.3 39 13.9 59.3 13.9 44.9 0 79.9-28.7 79.9-71.3.1-39-38.6-53-62.8-58.4z"/></svg>
                        <div class="text">
                            <h3>Imo Channel</h3>
                        </div>
                    </a>

                </div>
            </div>
        </div>

        <div id="support-chat-page" class="page">
            <div class="container">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div id="chat-typing-indicator-area"></div>
                    <div id="chat-quick-replies" class="quick-replies"></div>
                    <div id="chat-input-area" class="chat-input-area"></div>
                     <div id="chat-rating-area" class="chat-rating-area" style="display: none;">
                        <p>আমাদের সাপোর্ট সেশনটি কেমন ছিল? অনুগ্রহ করে রেটিং দিন।</p>
                        <div class="rating-stars" id="rating-stars">
                            <span class="star" data-value="1">★</span>
                            <span class="star" data-value="2">★</span>
                            <span class="star" data-value="3">★</span>
                            <span class="star" data-value="4">★</span>
                            <span class="star" data-value="5">★</span>
                        </div>
                        <div class="rating-emoji" id="rating-emoji"></div>
                        <button id="submit-rating-btn" class="btn" style="width: auto; padding: 8px 20px; margin-top: 15px;" disabled>সাবমিট</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODIFIED: Social Feed Page with new Header -->
    <div id="social-feed-page">
        <header class="feed-header">
            <button class="icon-button" id="feed-back-btn">
                 <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            <div class="feed-title">
                <div class="feed-title-main">My Blood</div>
                <div class="feed-subtitle">DonorBook</div>
            </div>
            <!-- NEW: Refresh Button -->
            <button class="icon-button" id="feed-refresh-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </header>
        <div id="social-feed-container">
            <!-- Posts will be dynamically injected here -->
        </div>
    </div>


    <!-- Modals -->
    <div id="agreement-modal" class="modal" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 420px;">
            <h2>Term And Policy</h2>
             <ul style="text-align: left; padding-left: 15px; font-family: 'Hind Siliguri', sans-serif; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                <li style="margin-bottom: 8px;">আল্লাহর সন্তুষ্টির উদ্দেশ্য রক্ত দান করবেন।</li>
                <li style="margin-bottom: 8px;">ডোনার কে সালামের সহিত যথাযথ সম্মান দিয়ে কথা বলতে হবে।</li>
                <li style="margin-bottom: 8px;">My Blood এপ্লিকেশন থেকে ডোনারকে কল দিলে অবশ্যই বলতে হবে 'আমি My Blood অ্যাপ্লিকেশন থেকে আপনার নাম্বার পেয়েছি'।</li>
                <li style="margin-bottom: 8px;">ডোনার কে অবশ্যই রক্তদান শেষে তার আসা যাওয়ার যাবতীয় খরচ বহন করবেন।</li>
                <li style="margin-bottom: 8px;">অবশ্যই রক্তদানের পর ডোনার কে ভালো ভাবে খাওয়াবেন।</li>
                <li style="margin-bottom: 8px;">রক্তদানের পর অবশ্যই ডোনারকে My Blood অ্যাপ্লিকেশনে লাস্ট ডোনেশন আপডেট করতে বলবেন।</li>
                <li style="margin-bottom: 8px;">My Blood অ্যাপ্লিকেশনের ডোনারদের নিজের কোনো রক্তদান সংস্থার নামে চালাবেন না। অন্যথায় My Blood কর্তৃপক্ষ যেকোনো আইনানুগ ব্যবস্থা নেওয়ার অধিকার রাখে।</li>
            </ul>
            <div class="checkbox-group" style="margin-top: 20px;">
                <input type="checkbox" id="initial-agreement-checkbox">
                <label for="initial-agreement-checkbox">আমি উপরের সকল শর্তে রাজি আছি।</label>
            </div>
            <button id="agree-btn" class="btn" style="margin-top: 15px;" disabled>I Agree</button>
        </div>
    </div>
    
    <div id="blocked-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="blocked-title">Account Blocked</h2>
            <div id="blocked-info" class="block-reason"></div>
            
            <div id="appeal-section">
                <button id="request-appeal-btn" class="btn" style="background-color:#3498db;">Request An Appeal</button>
                <form id="appeal-form" style="display: none; text-align: left; margin-top: 20px;">
                    <h3>Submit Your Appeal</h3>
                    <div class="form-group">
                        <label for="appeal-name">Name</label>
                        <input type="text" id="appeal-name" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="appeal-user-id">User ID or Registered Number</label>
                        <input type="text" id="appeal-user-id" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="appeal-message">Describe Your Application</label>
                        <textarea id="appeal-message" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn">Submit Appeal</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="pre-gift-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>ডেভেলপারকে হাদিয়া দিন</h2>
            <p>অ্যাপ উন্নতি ও ডেভেলপারের কাজের জন্য নিম্নোক্ত নাম্বারে Send Money করুন।</p>
            <div class="dev-number">01323491257</div>
            
            <form id="pre-gift-form" style="margin-top: 20px; text-align: left;">
                <div class="checkbox-group">
                    <input type="checkbox" id="confirm-send-money-checkbox">
                    <label for="confirm-send-money-checkbox">আপনি কি নিশ্চিত সেন্ড মানি করবেন? Send Money করতে টিক বক্সে টিক দিয়ে নাম্বার টি কপি করে আপনার মোবাইল ব্যাংকিং থেকে অনুদান পাঠান।</label>
                </div>

                <button type="button" id="copy-pre-gift-number-btn" class="btn" style="width: auto; padding: 8px 15px; margin: 5px auto; display: block; background-color: #3498db; font-size: 0.9rem;" disabled>👉এখানে ক্লিক করে নম্বর কপি করুন</button>
                <p id="copy-message">দয়া করে কপি করা নাম্বারটিতে আপনার বিকাশ/নগদ/রকেট Send Money করুন। এবং নিচের বক্সে Transaction Id টি দিন। ধন্যবাদ</p>

                <div class="checkbox-group">
                    <input type="checkbox" id="confirm-donation-done-checkbox" disabled>
                    <label for="confirm-donation-done-checkbox">আপনি কি ডোনেশন করেছেন? করলে টিক মার্ক দিন। এবং নিচের তথ্য পূরণ করুন </label>
                </div>

                <div class="form-group">
                    <label for="pre-gift-trx-id">Send Money Transaction Id Or Sender Mobile Number</label>
                    <input type="text" id="pre-gift-trx-id" required disabled>
                </div>
                
                <button type="submit" id="pre-gift-next-btn" class="btn" disabled>Next</button>
                <button type="button" id="close-pre-gift-modal-btn" class="btn close-modal-btn">Cancel</button>
            </form>
        </div>
    </div>


    <!-- Donation Eligibility Modal -->
    <div id="donation-eligibility-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>রক্তদানের জন্য প্রস্তুত!</h2>
            <p>প্রিয় ইউজার, আপনার রক্তদানের সময় হয়েছে।</p>
            <p>আপনি <strong id="eligibility-date" style="color: var(--primary-color);"></strong> তারিখ থেকে রক্তদানের জন্য প্রস্তুত।</p>
            <button id="close-eligibility-modal-btn" class="btn">ওকে</button>
             <p style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                ইতেমধ্যে রক্ত দান করে থাকলে আপনার লাস্ট ডোনেশন আপডেট করুন
            </p>
            <button id="update-donation-from-modal-btn" class="btn" style="background-color: #27ae60; margin-top: 5px;">Donation Update</button>
        </div>
    </div>
    
    <!-- Update Last Donation Modal -->
    <div id="update-donation-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Update Last Donation</h2>
            <p>Please select the date of your recent donation.</p>
            <form id="update-donation-form">
                <div class="form-group">
                    <label for="modal-last-donation">Last Donation Date</label>
                    <input type="date" id="modal-last-donation" required>
                </div>
                <button type="submit" class="btn">Update</button>
                <button type="button" id="close-update-modal-btn" class="btn" style="background-color: #7f8c8d; margin-top:10px;">Cancel</button>
            </form>
        </div>
    </div>
    
    <div id="social-join-modal" class="modal" style="display: none; z-index: 10001;">
        <div class="modal-content">
            <button class="update-close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</button>
            <h2>Join Our Channels!</h2>
            <p>নিয়মিত আপডেট পেতে আমাদের চ্যানেল গুলোতে জয়েন হোন।</p>
            <a href="https://t.me/TeamTawHaaOFC" class="social-channel-link" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" fill="#2AABEE"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142.3 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4.2 20.8 2.7 17.2 15.1z"/></svg>
                <span class="channel-name">Telegram</span>
            </a>
            <a href="https://s.channelcom.tech/Jz62a5?from=copy_link" class="social-channel-link" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="#8A3DA2"><path d="M448 32H0V480H448V32zM189.3 214.5c-6-3.8-12.8-5.9-19.9-5.9c-20.2 0-36.6 16.4-36.6 36.6c0 20.2 16.4 36.6 36.6 36.6c7.1 0 13.9-2.1 19.9-5.9v10.1c0 14.3-11.6 25.9-25.9 25.9s-25.9-11.6-25.9-25.9V225.3c0-14.3 11.6-25.9 25.9-25.9s25.9 11.6 25.9 25.9v-10.8zM315.3 214.5c-6-3.8-12.8-5.9-19.9-5.9c-20.2 0-36.6 16.4-36.6 36.6c0 20.2 16.4 36.6 36.6 36.6c7.1 0 13.9-2.1 19.9-5.9v10.1c0 14.3-11.6 25.9-25.9 25.9s-25.9-11.6-25.9-25.9V225.3c0-14.3 11.6-25.9 25.9-25.9s25.9 11.6 25.9 25.9v-10.8z"/></svg>
                 <span class="channel-name">Imo</span>
            </a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- START: Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB2RfuqjfIwnlFIPV9oO8RBRHcz8CDGTOc",
            authDomain: "my-blood-46d4e.firebaseapp.com",
            projectId: "my-blood-46d4e",
            storageBucket: "my-blood-46d4e.firebasestorage.app",
            messagingSenderId: "674499776907",
            appId: "1:674499776907:web:3197378814433cc7ea1f8e",
            measurementId: "G-FXCZP57RPN"
        };
        // --- END: Firebase Configuration ---

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {

            const APP_VERSION_CODE = 9; 
            let isNavigatingBack = false; // Flag for back button logic

            const state = {
                currentUser: null,
                allUsers: [],
                allNotifications: [],
                preGiftTrxId: null,
            };

            const thanaData = {
                "Bagerhat": ["Bagerhat Sadar", "Chitalmari", "Fakirhat", "Kachua", "Mollahat", "Mongla", "Morrelganj", "Rampal", "Sarankhola"],
                "Bandarban": ["Bandarban Sadar", "Thanchi", "Lama", "Naikhongchhari", "Ali Kadam", "Rowangchhari", "Ruma"],
                "Barguna": ["Amtali", "Bamna", "Barguna Sadar", "Betagi", "Patharghata", "Taltali"],
                "Barisal": ["Agailjhara", "Babuganj", "Bakerganj", "Banaripara", "Gaurnadi", "Hizla", "Barishal Sadar", "Mehendiganj", "Muladi", "Wazirpur"],
                "Bhola": ["Bhola Sadar", "Burhanuddin", "Char Fasson", "Daulatkhan", "Lalmohan", "Manpura", "Tazumuddin"],
                "Bogra": ["Adamdighi", "Bogra Sadar", "Dhunat", "Dhupchanchia", "Gabtali", "Kahaloo", "Nandigram", "Sariakandi", "Shajahanpur", "Sherpur", "Shibganj", "Sonatala"],
                "Brahmanbaria": ["Akhaura", "Bancharampur", "Brahmanbaria Sadar", "Kasba", "Nabinagar", "Nasirnagar", "Sarail", "Ashuganj", "Bijoynagar"],
                "Chandpur": ["Chandpur Sadar", "Faridganj", "Haimchar", "Haziganj", "Kachua", "Matlab Dakshin", "Matlab Uttar", "Shahrasti"],
                "Chapainawabganj": ["Bholahat", "Gomastapur", "Nachole", "Nawabganj Sadar", "Shibganj"],
                "Chittagong": ["Anwara", "Banshkhali", "Boalkhali", "Chandanaish", "Fatikchhari", "Hathazari", "Karnaphuli", "Lohagara", "Mirsharai", "Patiya", "Rangunia", "Raozan", "Sandwip", "Satkania", "Sitakunda", "Akbar Shah", "Bakolia", "Bandar", "Bayazid Bostami", "Chandgaon", "Chattogram Kotwali", "Double Mooring", "EPZ", "Halishahar", "Khulshi", "Pahartali", "Panchlaish", "Patenga"],
                "Chuadanga": ["Alamdanga", "Chuadanga Sadar", "Damurhuda", "Jibannagar"],
                "Comilla": ["Barura", "Brahmanpara", "Burichang", "Chandina", "Chauddagram", "Daudkandi", "Debidwar", "Homna", "Laksam", "Monohorgonj", "Meghna", "Muradnagar", "Nangalkot", "Cumilla Sadar", "Cumilla Sadar Dakshin", "Titas"],
                "Cox's Bazar": ["Chakaria", "Cox's Bazar Sadar", "Kutubdia", "Maheshkhali", "Ramu", "Teknaf", "Ukhia", "Pekua"],
                "Dhaka": ["Adabor", "Badda", "Bangshal", "Bimanbandar", "Cantonment", "Chak Bazar", "Dakshin Khan", "Darus Salam", "Demra", "Dhamrai", "Dhanmondi", "Dohar", "Gendaria", "Gulshan", "Hazaribagh", "Jatrabari", "Kadamtali", "Kafrul", "Kalabagan", "Kamrangirchar", "Keraniganj", "Khilgaon", "Khilkhet", "Kotwali", "Lalbagh", "Mirpur", "Mohammadpur", "Motijheel", "Nawabganj", "New Market", "Pallabi", "Paltan", "Ramna", "Rampura", "Sabujbagh", "Savar", "Shah Ali", "Shahbagh", "Sher-e-Bangla Nagar", "Shyampur", "Sutrapur", "Tejgaon", "Tejgaon Industrial Area", "Turag", "Uttar Khan", "Uttara"],
                "Dinajpur": ["Biral", "Birampur", "Birganj", "Bochaganj", "Chirirbandar", "Phulbari", "Ghoraghat", "Hakimpur", "Kaharole", "Khansama", "Dinajpur Sadar", "Nawabganj", "Parbatipur"],
                "Faridpur": ["Alfadanga", "Bhanga", "Boalmari", "Charbhadrasan", "Faridpur Sadar", "Madhukhali", "Nagarkanda", "Sadarpur", "Saltha"],
                "Feni": ["Chhagalnaiya", "Daganbhuiyan", "Feni Sadar", "Parshuram", "Sonagazi", "Fulgazi"],
                "Gaibandha": ["Phulchhari", "Gaibandha Sadar", "Gobindaganj", "Palashbari", "Sadullapur", "Sughatta", "Sundarganj"],
                "Gazipur": ["Gazipur Sadar", "Kaliakair", "Kaliganj", "Kapasia", "Sreepur"],
                "Gopalganj": ["Gopalganj Sadar", "Kasiani", "Kotalipara", "Muksudpur", "Tungipara"],
                "Habiganj": ["Ajmiriganj", "Bahubal", "Baniyachong", "Chunarughat", "Habiganj Sadar", "Lakhai", "Madhabpur", "Nabiganj", "Sayestaganj"],
                "Jamalpur": ["Baksiganj", "Dewanganj", "Islampur", "Jamalpur Sadar", "Madarganj", "Melandaha", "Sarishabari"],
                "Jessore": ["Abhaynagar", "Bagherpara", "Chaugachha", "Jhikargachha", "Keshabpur", "Jashore Sadar", "Manirampur", "Sharsha"],
                "Jhalokati": ["Jhalokati Sadar", "Kathalia", "Nalchity", "Rajapur"],
                "Jhenaidah": ["Harinakunda", "Jhenaidah Sadar", "Kaliganj", "Kotchandpur", "Maheshpur", "Shailkupa"],
                "Joypurhat": ["Akkelpur", "Joypurhat Sadar", "Kalai", "Khetlal", "Panchbibi"],
                "Khagrachhari": ["Dighinala", "Khagrachhari", "Lakshmichhari", "Mahalchhari", "Manikchhari", "Matiranga", "Panchhari", "Ramgarh"],
                "Khulna": ["Batiaghata", "Dacope", "Dighalia", "Dumuria", "Koyra", "Paikgachha", "Phultala", "Rupsha", "Terokhada", "Daulatpur", "Khalishpur", "Khan Jahan Ali", "Kotwali", "Sonadanga", "Harintana"],
                "Kishoreganj": ["Austagram", "Bajitpur", "Bhairab", "Hossainpur", "Itna", "Karimganj", "Katiadi", "Kishoreganj Sadar", "Kuliarchar", "Mithamain", "Nikli", "Pakundia", "Tarail"],
                "Kurigram": ["Bhurungamari", "Char Rajibpur", "Chilmari", "Phulbari", "Kurigram Sadar", "Nageshwari", "Rajarhat", "Raomari", "Ulipur"],
                "Kushtia": ["Bheramara", "Daulatpur", "Khoksa", "Kumarkhali", "Kushtia Sadar", "Mirpur"],
                "Lakshmipur": ["Lakshmipur Sadar", "Raipur", "Ramganj", "Ramgati", "Kamalnagar"],
                "Lalmonirhat": ["Aditmari", "Hatibandha", "Kaliganj", "Lalmonirhat Sadar", "Patgram"],
                "Madaripur": ["Dasar", "Kalkini", "Madaripur Sadar", "Rajoir", "Shibchar"],
                "Magura": ["Magura Sadar", "Mohammadpur", "Shalikha", "Sreepur"],
                "Manikganj": ["Daulatpur", "Ghior", "Harirampur", "Manikganj Sadar", "Saturia", "Shivalaya", "Singair"],
                "Meherpur": ["Gangni", "Meherpur Sadar", "Mujibnagar"],
                "Moulvibazar": ["Barlekha", "Juri", "Kamalganj", "Kulaura", "Moulvibazar Sadar", "Rajnagar", "Sreemangal"],
                "Munshiganj": ["Gazaria", "Lohajang", "Munshiganj Sadar", "Sirajdikhan", "Sreenagar", "Tongibari"],
                "Mymensingh": ["Bhaluka", "Dhobaura", "Fulbaria", "Gafargaon", "Gauripur", "Haluaghat", "Ishwarganj", "Mymensingh Sadar", "Muktagachha", "Nandail", "Phulpur", "Trishal", "Tara Khanda"],
                "Naogaon": ["Atrai", "Badalgachhi", "Dhamoirhat", "Manda", "Mohadevpur", "Naogaon Sadar", "Niamatpur", "Patnitala", "Porsha", "Raninagar", "Sapahar"],
                "Narail": ["Kalia", "Lohagara", "Narail Sadar"],
                "Narayanganj": ["Araihazar", "Bandar", "Narayanganj Sadar", "Rupganj", "Sonargaon"],
                "Narsingdi": ["Belabo", "Monohardi", "Narsingdi Sadar", "Palash", "Raipura", "Shibpur"],
                "Natore": ["Bagatipara", "Baraigram", "Gurudaspur", "Lalpur", "Natore Sadar", "Singra", "Naldanga"],
                "Netrokona": ["Atpara", "Barhatta", "Durgapur", "Khaliajuri", "Kalmakanda", "Kendua", "Madan", "Mohanganj", "Netrokona Sadar", "Purbadhala"],
                "Nilphamari": ["Dimla", "Domar", "Jaldhaka", "Kishoreganj", "Nilphamari Sadar", "Saidpur"],
                "Noakhali": ["Begumganj", "Chatkhil", "Companionganj", "Hatiya", "Kabirhat", "Senbagh", "Sonaimuri", "Subarnachar", "Noakhali Sadar"],
                "Pabna": ["Atgharia", "Bera", "Bhangura", "Chatmohar", "Faridpur", "Ishwardi", "Pabna Sadar", "Santhia", "Sujanagar"],
                "Panchagarh": ["Atwari", "Boda", "Debiganj", "Panchagarh Sadar", "Tetulia"],
                "Patuakhali": ["Bauphal", "Dashmina", "Galachipa", "Kalapara", "Mirzaganj", "Patuakhali Sadar", "Rangabali", "Dumki"],
                "Pirojpur": ["Bhandaria", "Kawkhali", "Mathbaria", "Nazirpur", "Pirojpur Sadar", "Nesarabad (Swarupkathi)", "Zianagar"],
                "Rajbari": ["Baliakandi", "Goalandaghat", "Pangsha", "Rajbari Sadar", "Kalukhali"],
                "Rajshahi": ["Bagha", "Bagmara", "Charghat", "Durgapur", "Godagari", "Mohanpur", "Paba", "Puthia", "Tanore", "Boalia", "Motihar", "Rajpara", "Shah Mokdum"],
                "Rangamati": ["Bagaichhari", "Barkal", "Kawkhali (Betbunia)", "Belaichhari", "Kaptai", "Juraichhari", "Langadu", "Naniarchar", "Rajasthali", "Rangamati Sadar"],
                "Rangpur": ["Badarganj", "Gangachhara", "Kaunia", "Rangpur Sadar", "Mithapukur", "Pirgachha", "Pirganj", "Taraganj"],
                "Satkhira": ["Assasuni", "Debhata", "Kalaroa", "Kaliganj", "Satkhira Sadar", "Shyamnagar", "Tala"],
                "Shariatpur": ["Bhedarganj", "Damudya", "Gosairhat", "Naria", "Shariatpur Sadar", "Zajira", "Sakhipur"],
                "Sherpur": ["Jhenaigati", "Nakla", "Nalitabari", "Sherpur Sadar", "Sreebardi"],
                "Sirajganj": ["Belkuchi", "Chauhali", "Kamarkhanda", "Kazipur", "Raiganj", "Shahjadpur", "Sirajganj Sadar", "Tarash", "Ullahpara"],
                "Sunamganj": ["Bishwamvarpur", "Chhatak", "Derai", "Dharampasha", "Dowarabazar", "Jagannathpur", "Jamalganj", "Sullah", "Sunamganj Sadar", "Tahirpur", "South Sunamganj"],
                "Sylhet": ["Balaganj", "Beanibazar", "Bishwanath", "Dakshin Surma", "Companiganj", "Fenchuganj", "Golapganj", "Gowainghat", "Jaintiapur", "Kanaighat", "Sylhet Sadar", "Zakiganj", "Osmani Nagar"],
                "Tangail": ["Gopalpur", "Basail", "Bhuapur", "Delduar", "Ghatail", "Kalihati", "Madhupur", "Mirzapur", "Nagarpur", "Sakhipur", "Tangail Sadar", "Dhanbari"],
                "Thakurgaon": ["Baliadangi", "Haripur", "Pirganj", "Ranisankail", "Thakurgaon Sadar"]
            };

            const districts = Object.keys(thanaData).sort();
            
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const notificationBtn = document.getElementById('notification-btn');
            const notificationPanel = document.getElementById('notification-panel');
            const backToSupportBtn = document.getElementById('back-to-support-btn');
            const backToMenuBtn = document.getElementById('back-to-menu-btn'); 
            const feedBackBtn = document.getElementById('feed-back-btn');
            const socialFeedPage = document.getElementById('social-feed-page');

            const donationEligibilityModal = document.getElementById('donation-eligibility-modal');
            const eligibilityDateEl = document.getElementById('eligibility-date');
            const closeEligibilityModalBtn = document.getElementById('close-eligibility-modal-btn');
            const updateDonationFromModalBtn = document.getElementById('update-donation-from-modal-btn');
            const updateDonationModal = document.getElementById('update-donation-modal');
            const updateDonationForm = document.getElementById('update-donation-form');
            const modalLastDonationInput = document.getElementById('modal-last-donation');
            const closeUpdateModalBtn = document.getElementById('close-update-modal-btn');

            function populateSelectWithOptions(selectElement, options) {
                if (!selectElement) return;
                selectElement.innerHTML = '';
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    selectElement.appendChild(optionElement);
                });
            }

            function populateThanas(district, thanaSelectElement, thanaGroupElement) {
                if (district && thanaData[district]) {
                    thanaSelectElement.innerHTML = '<option value="">Select Thana</option>';
                    thanaData[district].forEach(thana => {
                        const option = document.createElement('option');
                        option.value = thana;
                        option.textContent = thana;
                        thanaSelectElement.appendChild(option);
                    });
                    if(thanaGroupElement) thanaGroupElement.style.display = 'block';
                } else {
                    thanaSelectElement.innerHTML = '<option value="">Select District First</option>';
                    if(thanaGroupElement) thanaGroupElement.style.display = 'none';
                }
            }


            function populateDistricts() {
                const districtSelects = document.querySelectorAll('#search-district, #reg-district, #acc-district');
                districtSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select District</option>';
                    districts.forEach(district => {
                        select.innerHTML += `<option value="${district}">${district}</option>`;
                    });
                });
            }
            populateDistricts();

            const bloodGroups = ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"];
            function populateBloodGroups(selectElement) {
                 if (!selectElement) return;
                selectElement.innerHTML = '<option value="">Select Blood Group</option>';
                bloodGroups.forEach(bg => {
                    selectElement.innerHTML += `<option value="${bg}">${bg}</option>`;
                });
            }
            populateBloodGroups(document.getElementById('acc-blood-group'));
            
            function convertToBengaliNumber(num) {
                if (num === null || num === undefined) return '০'; 
                const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
                return String(num).replace(/[0-9]/g, digit => bengaliDigits[digit]);
            }

            function setMaxDateForDonationInputs() {
                const today = new Date().toISOString().split("T")[0];
                document.getElementById('last-donation').max = today;
                document.getElementById('acc-last-donation').max = today;
                document.getElementById('modal-last-donation').max = today;
            }
            setMaxDateForDonationInputs();


            function showPage(pageId, fromHistory = false) {
                if (document.getElementById('support-chat-page').classList.contains('active') && pageId !== 'support-chat') {
                   clearChatTimers();
                }

                // MODIFICATION: Handle 'donorbook' separately
                if (pageId === 'donorbook') {
                    showSocialFeed();
                    return;
                }

                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(`${pageId}-page`);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                
                if (!fromHistory) {
                    const currentState = history.state;
                    if (!currentState || currentState.page !== pageId) {
                        history.pushState({ page: pageId }, '', `#${pageId}`);
                    }
                }

                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                socialFeedPage.classList.remove('active'); // MODIFICATION: Hide feed when changing pages
                window.scrollTo(0, 0);

                // Default header state
                menuToggleBtn.style.display = 'block';
                backToMenuBtn.style.display = 'none';
                backToSupportBtn.style.display = 'none';

                if (pageId === 'support-chat') {
                    menuToggleBtn.style.display = 'none';
                    backToSupportBtn.style.display = 'block';
                } else if (pageId !== 'home') {
                    menuToggleBtn.style.display = 'none';
                    backToMenuBtn.style.display = 'block';
                }
            }
            
            backToSupportBtn.addEventListener('click', () => showPage('support'));
            backToMenuBtn.addEventListener('click', openSidebar);

            navLinks.forEach(link => link.addEventListener('click', (e) => { 
                e.preventDefault(); 
                const page = e.target.closest('a').dataset.page;
                if(page) {
                    showPage(page);
                }
            }));

            menuToggleBtn.addEventListener('click', openSidebar);
            overlay.addEventListener('click', () => history.back());
            
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationPanel.classList.toggle('show');
                
                if (notificationPanel.classList.contains('show')) {
                    loadNotifications();
                    const storageKey = state.currentUser ? `my_blood_last_notif_check_${state.currentUser.id}` : 'my_blood_last_notif_check_guest';
                    localStorage.setItem(storageKey, new Date().toISOString());
                    updateNotificationCount();
                }
            });

            document.addEventListener('click', (e) => {
                const isClickInsidePanel = notificationPanel.contains(e.target);
                const isClickOnButton = notificationBtn.contains(e.target);
                
                if (notificationPanel.classList.contains('show') && !isClickInsidePanel && !isClickOnButton) {
                    notificationPanel.classList.remove('show');
                }
            });

            function updateUIForLoginState() {
                const loggedInElements = document.querySelectorAll('.logged-in');
                const loggedOutElements = document.querySelectorAll('.logged-out');

                if (state.currentUser) {
                    if (checkUserStatus(state.currentUser)) return;
                    loggedInElements.forEach(el => el.style.display = 'block');
                    loggedOutElements.forEach(el => el.style.display = 'none');
                    loadAccountData();
                    listenForUserSpecificNotifications();
                    checkDonationEligibility();
                } else {
                    loggedInElements.forEach(el => el.style.display = 'none');
                    loggedOutElements.forEach(el => el.style.display = 'block');
                }
                updateNotificationCount();
            }
            
            function setCurrentUser(user) {
                if (user) {
                    state.currentUser = user;
                    localStorage.setItem('my_blood_currentUserMobile', user.mobile);
                } else {
                    state.currentUser = null;
                    localStorage.removeItem('my_blood_currentUserMobile');
                }
                updateUIForLoginState();
            }

            function checkDonationEligibility() {
                const user = state.currentUser;
                if (!user || !user.lastDonation) { return; }
                const lastDonationDate = new Date(user.lastDonation);
                const eligibilityDate = new Date(lastDonationDate);
                eligibilityDate.setDate(eligibilityDate.getDate() + 90);
                const today = new Date();
                today.setHours(0, 0, 0, 0); eligibilityDate.setHours(0, 0, 0, 0);

                if (today >= eligibilityDate) {
                    const notifiedDate = localStorage.getItem(`my_blood_notified_for_${user.id}`);
                    if (notifiedDate !== user.lastDonation) {
                        const formattedEligibilityDate = eligibilityDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
                        const notificationMessage = `আপনার রক্তদানের সময় হয়েছে। আপনি ${formattedEligibilityDate} থেকে রক্তদানের জন্য প্রস্তুত।`;
                        eligibilityDateEl.textContent = formattedEligibilityDate;
                        donationEligibilityModal.style.display = 'flex';
                        addNotification(user.id, notificationMessage);
                        localStorage.setItem(`my_blood_notified_for_${user.id}`, user.lastDonation);
                    }
                }
            }
            
            closeEligibilityModalBtn.addEventListener('click', () => { donationEligibilityModal.style.display = 'none'; });
            updateDonationFromModalBtn.addEventListener('click', () => {
                donationEligibilityModal.style.display = 'none';
                modalLastDonationInput.max = new Date().toISOString().split("T")[0];
                updateDonationModal.style.display = 'flex';
            });
            closeUpdateModalBtn.addEventListener('click', () => { updateDonationModal.style.display = 'none'; });

            updateDonationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const currentUser = state.currentUser; if (!currentUser) return;
                const newDate = modalLastDonationInput.value; if (!newDate) { alert('Please select a date.'); return; }
                const newTotalDonations = (currentUser.totalDonations || 0) + 1;
                const updatedData = { lastDonation: newDate, totalDonations: newTotalDonations };

                database.ref('users/' + currentUser.mobile).update(updatedData).then(() => {
                    alert('Thank you for your donation! Your profile has been updated.');
                    updateDonationModal.style.display = 'none'; updateDonationForm.reset();
                    addNotification(currentUser.id, `Your donation on ${newDate} has been recorded. Total donations: ${newTotalDonations}.`);
                }).catch(err => { alert('There was an error updating your profile. Please try again.'); console.error(err); });
            });
            
            const blockedModal = document.getElementById('blocked-user-modal');
            const blockedInfo = document.getElementById('blocked-info');
            const appealSection = document.getElementById('appeal-section');
            const blockedTitle = document.getElementById('blocked-title');

            function checkUserStatus(user) {
                const freshUser = state.allUsers.find(u => u.mobile === user.mobile);
                if (!freshUser) { alert('Your account may have been deleted.'); handleLogout(); return true; }
                state.currentUser = freshUser; 
                const isBlocked = freshUser.blocked && new Date() < new Date(freshUser.blockEndDate);
                const isAppealRejected = freshUser.appealRejectedUntil && new Date() < new Date(freshUser.appealRejectedUntil);

                if (isAppealRejected) {
                    const remainingTime = new Date(freshUser.appealRejectedUntil) - new Date();
                    const remainingDays = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                    blockedTitle.textContent = "Your Appeal Was Rejected";
                    blockedInfo.innerHTML = `Your appeal has been rejected. You can re-appeal after <strong>${remainingDays > 0 ? remainingDays : 0} day(s)</strong>.`;
                    appealSection.style.display = 'none'; blockedModal.style.display = 'flex'; return true;
                }

                if (isBlocked) {
                    const blockEndDate = new Date(freshUser.blockEndDate).toLocaleString();
                    blockedTitle.textContent = "Account Blocked";
                    blockedInfo.innerHTML = `Your account is blocked until <strong>${blockEndDate}</strong>.<br><strong>Reason:</strong> ${freshUser.blockReason || 'Not specified'}`;
                    database.ref('appeals').orderByChild('userMobile').equalTo(freshUser.mobile).once('value', snapshot => {
                        appealSection.innerHTML = snapshot.exists() ? '<p>Your appeal has been submitted and is under review.</p>' : `<button id="request-appeal-btn" class="btn" style="background-color:#3498db;">Request An Appeal</button>`;
                    });
                    appealSection.style.display = 'block'; blockedModal.style.display = 'flex'; return true;
                }
                blockedModal.style.display = 'none'; return false;
            }

            blockedModal.addEventListener('click', (e) => {
                if (e.target.id === 'request-appeal-btn') {
                    const user = state.currentUser;
                    appealSection.innerHTML = `
                        <form id="appeal-form" style="text-align: left; margin-top: 20px;">
                            <h3>Submit Your Appeal</h3>
                            <div class="form-group"><label>Name</label><input type="text" id="appeal-name" required readonly value="${user.name}"></div>
                            <div class="form-group"><label>Registered Number</label><input type="text" id="appeal-user-id" required readonly value="${user.mobile}"></div>
                            <div class="form-group"><label>Describe Your Application</label><textarea id="appeal-message" rows="4" required></textarea></div>
                            <button type="submit" class="btn">Submit Appeal</button>
                        </form>`;
                    document.getElementById('appeal-form').addEventListener('submit', handleAppealSubmit);
                }
            });

            function handleAppealSubmit(e) {
                e.preventDefault();
                const user = state.currentUser; const message = document.getElementById('appeal-message').value;
                if (!message.trim()) { alert('Please describe your application.'); return; }
                const newAppeal = { userId: user.id, userName: user.name, userMobile: user.mobile, appealMessage: message, date: new Date().toISOString() };
                database.ref('appeals').push(newAppeal).then(() => {
                    appealSection.innerHTML = '<p>Your appeal has been submitted and is under review.</p>';
                    addNotification(user.id, 'Your Appeal Was Submitted Successfully.');
                });
            }

            const registerForm = document.getElementById('register-form');
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault(); const mobile = document.getElementById('reg-mobile').value;
                database.ref('users/' + mobile).once('value', snapshot => {
                    if (snapshot.exists()) { alert('This number is already registered. Please login.'); return; }
                    const newUser = {
                        id: Math.floor(10000 + Math.random() * 90000), name: document.getElementById('reg-name').value, mobile: mobile,
                        bloodGroup: document.getElementById('reg-blood-group').value, gender: document.querySelector('input[name="gender"]:checked').value,
                        district: document.getElementById('reg-district').value,
                        thana: document.getElementById('reg-thana').value, 
                        lastDonation: document.getElementById('no-donated').checked ? null : document.getElementById('last-donation').value || null,
                        password: document.getElementById('reg-password').value,
                        totalDonations: parseInt(document.getElementById('reg-total-donations').value) || 0,
                        registrationDate: new Date().toISOString() 
                    };
                    database.ref('users/' + mobile).set(newUser).then(() => {
                        alert(`Congratulation🎉\nYour Account Was Created Successful.\nYour User ID is: ${newUser.id}\nDon't share your password and user id.`);
                        setCurrentUser(newUser); addNotification(newUser.id, 'Your Registration Was Complete Successfully.');
                        showPage('home'); registerForm.reset();
                    });
                });
            });
            document.getElementById('no-donated').addEventListener('change', function() {
                document.getElementById('last-donation').disabled = this.checked;
                document.getElementById('reg-total-donations').disabled = this.checked;
                if(this.checked) { 
                    document.getElementById('last-donation').value = ''; 
                    document.getElementById('reg-total-donations').value = '';
                }
            });

            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const loginId = document.getElementById('login-id').value; const password = document.getElementById('login-password').value;
                const user = state.allUsers.find(u => (u.mobile === loginId || u.id.toString() === loginId) && u.password === password);
                if(user) {
                    if (checkUserStatus(user)) { addNotification(user.id, 'A login attempt was made on your blocked account.'); return; }
                    setCurrentUser(user); addNotification(user.id, 'Login Successfully.');
                    alert('Login Successfully!'); showPage('home'); loginForm.reset();
                } else { alert('Invalid credentials. Please try again.'); }
            });

            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const resetPasswordForm = document.getElementById('reset-password-form');
            let userToResetPassword = null; let forgotPasswordAttempts = 0;

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault(); showPage('forgot-password');
                forgotPasswordForm.reset(); resetPasswordForm.reset();
                forgotPasswordForm.style.display = 'block'; resetPasswordForm.style.display = 'none';
                userToResetPassword = null; forgotPasswordAttempts = 0;
            });

            forgotPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault(); const mobile = document.getElementById('fp-mobile').value; const lastThree = document.getElementById('fp-last-three').value;
                const user = state.allUsers.find(u => u.mobile === mobile);
                if (user && user.password && user.password.slice(-3) === lastThree) {
                    userToResetPassword = user;
                    forgotPasswordForm.style.display = 'none'; resetPasswordForm.style.display = 'block';
                } else {
                    forgotPasswordAttempts++;
                    if (forgotPasswordAttempts >= 3) { alert('Too many attempts. Please contact support for help.'); showPage('support'); }
                    else { alert(`Information does not match. You have ${3 - forgotPasswordAttempts} attempts left.`); }
                }
            });

            resetPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault(); const newPassword = document.getElementById('fp-new-password').value;
                if (userToResetPassword) {
                    database.ref('users/' + userToResetPassword.mobile + '/password').set(newPassword)
                    .then(() => {
                        addNotification(userToResetPassword.id, 'Your Password Was Changed Successfully.');
                        alert('Password changed successfully. Please login.'); showPage('login');
                    });
                }
            });

            document.getElementById('search-donor-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const bloodGroup = document.getElementById('search-blood-group').value;
                const district = document.getElementById('search-district').value;
                const searchByThana = document.getElementById('search-by-thana-checkbox').checked;
                const thana = document.getElementById('search-thana').value;

                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                const availableDonors = state.allUsers.filter(user => {
                    const isDistrictMatch = user.district === district;
                    const isThanaMatch = !searchByThana || (user.thana === thana);
                    const isMatch = user.bloodGroup === bloodGroup && isDistrictMatch && isThanaMatch;
                    
                    const isAvailable = !user.lastDonation || new Date(user.lastDonation) < threeMonthsAgo;
                    const isBlocked = user.blocked && new Date() < new Date(user.blockEndDate);
                    
                    return isMatch && isAvailable && !isBlocked;
                });
                displayDonors(availableDonors);
            });
            
            function displayDonors(donors) {
                const donorList = document.getElementById('donor-list'); donorList.innerHTML = '';
                if (donors.length === 0) { donorList.innerHTML = '<p id="no-donors-found">No available donors found.</p>'; return; }
                donors.forEach(donor => {
                    donorList.innerHTML += `
                        <div class="donor-card">
                            <div class="avatar">${donor.gender === 'Male' ? `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><g fill="none"><path d="M0 0h24v24H0V0z"/><path d="M0 0h24v24H0V0z" opacity=".87"/></g><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v1c0 .55.45 1 1 1h14c.55 0 1-.45 1-1v-1c0-2.66-5.33-4-8-4z"/></svg>`}</div>
                            <div class="info">
                                <p class="name">${donor.name}</p>
                                <p class="blood-group">Blood Group: ${donor.bloodGroup}</p>
                                <p>Location: ${donor.thana || 'N/A'}, ${donor.district}</p>
                                <p>মোট রক্তদান: ${convertToBengaliNumber(donor.totalDonations || 0)} বার</p>
                                <p>Last Donation: ${donor.lastDonation ? new Date(donor.lastDonation).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <a href="tel:${donor.mobile}" class="call-btn">Call Now</a>
                        </div>`;
                });
            }

            function loadAccountData() {
                const user = state.currentUser;
                if (user) {
                    document.getElementById('acc-userid').value = user.id; 
                    document.getElementById('acc-name').value = user.name;
                    document.getElementById('acc-mobile').value = user.mobile; 
                    document.getElementById('acc-blood-group').value = user.bloodGroup;
                    document.getElementById('acc-district').value = user.district;
                    
                    if (user.district) {
                        const thanaSelect = document.getElementById('acc-thana');
                        const thanaGroup = document.getElementById('acc-thana-group');
                        populateThanas(user.district, thanaSelect, thanaGroup);
                        thanaSelect.value = user.thana || '';
                    }

                    document.getElementById('acc-last-donation').value = user.lastDonation || '';
                    document.querySelector(`input[name="acc-gender"][value="${user.gender}"]`).checked = true;
                    document.getElementById('acc-total-donations').value = user.totalDonations || 0;
                }
            }
            document.getElementById('account-form').addEventListener('submit', (e) => {
                e.preventDefault(); const currentUser = state.currentUser; if (!currentUser) return;
                const oldLastDonation = currentUser.lastDonation; const newLastDonation = document.getElementById('acc-last-donation').value;
                let newTotalDonations = parseInt(document.getElementById('acc-total-donations').value) || 0;
                if (newLastDonation && newLastDonation !== oldLastDonation) { newTotalDonations = (parseInt(currentUser.totalDonations) || 0) + 1; }
                const updatedData = {
                    name: document.getElementById('acc-name').value, 
                    bloodGroup: document.getElementById('acc-blood-group').value,
                    gender: document.querySelector('input[name="acc-gender"]:checked').value, 
                    district: document.getElementById('acc-district').value,
                    thana: document.getElementById('acc-thana').value, 
                    lastDonation: newLastDonation || null, 
                    totalDonations: newTotalDonations,
                };
                database.ref('users/' + currentUser.mobile).update(updatedData).then(() => {
                    addNotification(currentUser.id, 'Your Profile Has been Update Successfully.');
                    alert('Profile updated successfully!'); showPage('home');
                });
            });
            
            document.getElementById('delete-account-btn').addEventListener('click', () => {
                const currentUser = state.currentUser;
                if (!currentUser) return;

                const enteredPassword = prompt("আপনার অ্যাকাউন্ট ডিলিট করতে, অনুগ্রহ করে আপনার পাসওয়ার্ড লিখুন:");

                if (enteredPassword === null) return;

                if (enteredPassword === currentUser.password) {
                    if (confirm('আপনি কি সত্যিই আপনার অ্যাকাউন্ট ডিলিট করতে চান? এই কাজটি আর ফেরানো যাবে না।')) {
                        database.ref('users/' + currentUser.mobile).remove()
                            .then(() => {
                                handleLogout();
                                alert('আপনার অ্যাকাউন্ট সফলভাবে ডিলিট করা হয়েছে।');
                                showPage('home');
                            })
                            .catch(error => {
                                alert('অ্যাকাউন্ট ডিলিট করার সময় একটি সমস্যা হয়েছে।');
                                console.error("Account deletion error:", error);
                            });
                    }
                } else {
                    alert("ভুল পাসওয়ার্ড। অ্যাকাউন্ট ডিলিট বাতিল করা হয়েছে।");
                }
            });
            
            function handleLogout() {
                if (state.currentUser) addNotification(state.currentUser.id, 'Logout Successfully.');
                setCurrentUser(null); showPage('home');
            }
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault(); if (confirm('Are you sure you want to log out?')) { handleLogout(); }
            });

            const feedbackForm = document.getElementById('feedback-form');
            const feedbackName = document.getElementById('feedback-name');
            const feedbackMobile = document.getElementById('feedback-mobile');
            const feedbackEmail = document.getElementById('feedback-email');
            const feedbackText = document.getElementById('feedback-text');
            const feedbackSubmitBtn = document.getElementById('feedback-submit-btn');

            function validateFeedbackForm() {
                const nameValid = feedbackName.value.trim() !== '';
                const mobileValid = /^[0-9]{11}$/.test(feedbackMobile.value);
                const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(feedbackEmail.value);
                const textValid = feedbackText.value.trim() !== '';
                feedbackSubmitBtn.disabled = !(nameValid && mobileValid && emailValid && textValid);
            }

            [feedbackName, feedbackMobile, feedbackEmail, feedbackText].forEach(el => el.addEventListener('input', validateFeedbackForm));
            
            feedbackMobile.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length > 11) {
                    value = value.slice(0, 11);
                }
                e.target.value = value;
            });

            feedbackForm.addEventListener('submit', (e) => {
                e.preventDefault();
                validateFeedbackForm(); 
                if(feedbackSubmitBtn.disabled) return;

                const feedbackNumber = Math.floor(1000000000 + Math.random() * 9000000000);
                
                const feedbackData = {
                    name: feedbackName.value,
                    mobile: feedbackMobile.value,
                    email: feedbackEmail.value,
                    feedback: feedbackText.value,
                    feedbackNumber: feedbackNumber,
                    date: new Date().toISOString(),
                };
                
                database.ref('feedback').push(feedbackData).then(() => {
                    const successMessage = `Thanks For Your Feedback🎉 Your Feedback Number is ${feedbackNumber}. You Will Receive An Email From Us Shortly.`;
                    
                    if(state.currentUser) {
                         addNotification(state.currentUser.id, successMessage);
                    } else {
                        state.allNotifications.push({
                            id: `guest_feedback_${feedbackNumber}`,
                            message: successMessage,
                            time: new Date().toISOString(),
                            isUserSpecific: false 
                        });
                        updateNotificationCount();
                    }

                    alert(successMessage);
                    feedbackForm.reset(); 
                    feedbackSubmitBtn.disabled = true;
                    showPage('home');
                }).catch(err => {
                    alert('An error occurred. Please try again.');
                    console.error("Feedback submission error:", err);
                });
            });


            const giftLink = document.getElementById('gift-link');
            const giftForm = document.getElementById('gift-form');
            const preGiftModal = document.getElementById('pre-gift-modal');
            const preGiftForm = document.getElementById('pre-gift-form');
            const confirmSendMoneyCheckbox = document.getElementById('confirm-send-money-checkbox');
            const copyPreGiftNumberBtn = document.getElementById('copy-pre-gift-number-btn');
            const copyMessage = document.getElementById('copy-message');
            const confirmDonationDoneCheckbox = document.getElementById('confirm-donation-done-checkbox');
            const preGiftTrxIdInput = document.getElementById('pre-gift-trx-id');
            const preGiftNextBtn = document.getElementById('pre-gift-next-btn');
            const closePreGiftModalBtn = document.getElementById('close-pre-gift-modal-btn');
            

            giftLink.addEventListener('click', (e) => {
                e.preventDefault();
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                preGiftForm.reset();
                copyPreGiftNumberBtn.disabled = true;
                copyMessage.style.display = 'none';
                confirmDonationDoneCheckbox.disabled = true;
                confirmDonationDoneCheckbox.checked = false;
                preGiftTrxIdInput.disabled = true;
                preGiftTrxIdInput.value = '';
                preGiftNextBtn.disabled = true;
                preGiftModal.style.display = 'flex';
            });

            confirmSendMoneyCheckbox.addEventListener('change', () => {
                copyPreGiftNumberBtn.disabled = !confirmSendMoneyCheckbox.checked;
                if (!confirmSendMoneyCheckbox.checked) {
                    confirmDonationDoneCheckbox.disabled = true;
                    confirmDonationDoneCheckbox.checked = false;
                    preGiftTrxIdInput.disabled = true;
                    preGiftNextBtn.disabled = true;
                    copyMessage.style.display = 'none';
                }
            });

            copyPreGiftNumberBtn.addEventListener('click', () => {
                const devNumberEl = document.querySelector('#pre-gift-modal .dev-number');
                const numberToCopy = devNumberEl.textContent.trim();
                const copySuccess = () => {
                    copyPreGiftNumberBtn.textContent = 'কপি হয়েছে!';
                    copyMessage.style.display = 'block';
                    confirmDonationDoneCheckbox.disabled = false;
                    setTimeout(() => { copyPreGiftNumberBtn.textContent = '👉এখানে ক্লিক করে নম্বর কপি করুন'; }, 2000);
                };
                fallbackCopyTextToClipboard(numberToCopy, copySuccess);
            });

            confirmDonationDoneCheckbox.addEventListener('change', () => {
                preGiftTrxIdInput.disabled = !confirmDonationDoneCheckbox.checked;
                if (!confirmDonationDoneCheckbox.checked) {
                     preGiftNextBtn.disabled = true;
                }
                preGiftTrxIdInput.dispatchEvent(new Event('input'));
            });

            preGiftTrxIdInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^a-zA-Z0-9-]/g, '');
                preGiftNextBtn.disabled = !(preGiftTrxIdInput.value.trim() !== '' && confirmDonationDoneCheckbox.checked);
            });

            closePreGiftModalBtn.addEventListener('click', () => {
                preGiftModal.style.display = 'none';
            });
            
            preGiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                state.preGiftTrxId = preGiftTrxIdInput.value;
                preGiftModal.style.display = 'none';
                showPage('gift');
            });
            
            giftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const finalLastThree = document.getElementById('gift-trx-digits').value;
                const initialInput = state.preGiftTrxId;
                if (/^01[3-9][0-9]{8}$/.test(initialInput)) {
                    const initialLastThree = initialInput.slice(-3);
                    if (initialLastThree !== finalLastThree) {
                        alert("আপনি পূর্বে যে মোবাইল নম্বরটি দিয়েছেন তার শেষের ৩ সংখ্যার সাথে এই সংখ্যা মিলছে না।");
                        return;
                    }
                }
                
                const giftData = {
                    name: document.getElementById('gift-name').value,
                    mobile: '+88' + document.getElementById('gift-mobile').value,
                    address: document.getElementById('gift-address').value,
                    reason: document.getElementById('gift-reason').value,
                    giftAmount: parseInt(document.getElementById('gift-amount').value, 10),
                    paymentMethod: document.querySelector('input[name="payment_method"]:checked').value,
                    last3Digits: finalLastThree,
                    transactionInfo: state.preGiftTrxId,
                    date: new Date().toISOString()
                };
                database.ref('gifts').push(giftData).then(() => {
                    alert(`ধন্যবাদ প্রিয় ${giftData.name}, আপনার অনুদান পাঠিয়ে আমাদেরকে সহায়তা করার জন্য।`);
                    giftForm.reset();
                    state.preGiftTrxId = null;
                    showPage('home');
                });
            });

            function fallbackCopyTextToClipboard(text, successCallback) {
                const textArea = document.createElement("textarea");
                textArea.value = text; textArea.style.position = "absolute"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); if (successCallback) successCallback(); }
                catch (err) { alert('নম্বরটি কপি করা যায়নি। অনুগ্রহ করে ম্যানুয়াললি কপি করুন।'); }
                document.body.removeChild(textArea);
            }
            
            const complainForm = document.getElementById('complain-form');
            const complainOathCheckbox = document.getElementById('complain-oath');
            const complainSubmitBtn = document.getElementById('complain-submit-btn');

            complainOathCheckbox.addEventListener('change', () => {
                complainSubmitBtn.disabled = !complainOathCheckbox.checked;
            });

            complainForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const complainantName = document.getElementById('complainant-name').value.trim();
                const complainantMobile = document.getElementById('complainant-mobile').value.trim();
                const donorName = document.getElementById('donor-name').value.trim();
                const donorMobile = document.getElementById('donor-mobile').value.trim();

                if (complainantName === donorName && complainantMobile === donorMobile) {
                    alert('অভিযোগকারী এবং অভিযুক্তের নাম ও মোবাইল নম্বর একই হতে পারবে না।');
                    return; 
                }
                if (complainantMobile === donorMobile) {
                    alert('অভিযোগকারী এবং অভিযুক্তের মোবাইল নম্বর একই হতে পারবে না।');
                    return;
                }

                const complaintData = {
                    complainantName: complainantName,
                    complainantMobile: complainantMobile,
                    donorName: donorName,
                    donorMobile: donorMobile,
                    description: document.getElementById('complain-description').value,
                    date: new Date().toISOString(),
                };

                database.ref('complaints').push(complaintData).then(() => {
                    alert('আপনার অভিযোগ সফলভাবে জমা হয়েছে। আমরা খুব শীঘ্রই বিষয়টি খতিয়ে দেখব।');
                    complainForm.reset();
                    complainSubmitBtn.disabled = true; 
                    showPage('home');
                }).catch(error => {
                    alert('একটি সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
                    console.error("Complaint submission error:", error);
                });
            });

            document.getElementById('reg-district').addEventListener('change', (e) => {
                const selectedDistrict = e.target.value;
                const thanaSelect = document.getElementById('reg-thana');
                const thanaGroup = document.getElementById('reg-thana-group');
                populateThanas(selectedDistrict, thanaSelect, thanaGroup);
            });

            document.getElementById('acc-district').addEventListener('change', (e) => {
                const selectedDistrict = e.target.value;
                const thanaSelect = document.getElementById('acc-thana');
                const thanaGroup = document.getElementById('acc-thana-group');
                populateThanas(selectedDistrict, thanaSelect, thanaGroup);
            });

            document.getElementById('search-district').addEventListener('change', (e) => {
                const selectedDistrict = e.target.value;
                const thanaContainer = document.getElementById('search-thana-container');
                const thanaCheckbox = document.getElementById('search-by-thana-checkbox');
                const thanaGroup = document.getElementById('search-thana-group');
                const thanaSelect = document.getElementById('search-thana');

                if (selectedDistrict) {
                    thanaContainer.style.display = 'block';
                    populateThanas(selectedDistrict, thanaSelect, thanaGroup);
                    thanaCheckbox.checked = false; 
                    thanaGroup.style.display = 'none'; 
                } else {
                    thanaContainer.style.display = 'none';
                }
            });

            document.getElementById('search-by-thana-checkbox').addEventListener('change', (e) => {
                const thanaGroup = document.getElementById('search-thana-group');
                thanaGroup.style.display = e.target.checked ? 'block' : 'none';
            });

            function deleteUserNotification(notificationId) {
                if (!state.currentUser) return;
                if (notificationId.startsWith('guest_feedback_')) {
                    state.allNotifications = state.allNotifications.filter(n => n.id !== notificationId);
                    loadNotifications(); 
                    updateNotificationCount();
                    return;
                }
                database.ref('user_notifications/' + state.currentUser.id + '/' + notificationId).remove()
                    .catch(error => {
                        console.error("Error deleting notification:", error);
                    });
            }
            
            function addNotification(userId, message) {
                if (!userId) return;
                const user = state.allUsers.find(u => u.id.toString() === userId.toString());
                if (!user) return; 
                database.ref('user_notifications/' + userId).push({ message: message, time: new Date().toISOString() });
            }
            
            function updateNotificationCount() {
                const countBadge = document.getElementById('notification-count');
                const notifButton = document.getElementById('notification-btn');

                const storageKey = state.currentUser ? `my_blood_last_notif_check_${state.currentUser.id}` : 'my_blood_last_notif_check_guest';
                const lastCheckTime = localStorage.getItem(storageKey) || '1970-01-01T00:00:00.000Z';
                
                let relevantNotifications = state.allNotifications;
                if (!state.currentUser) {
                    relevantNotifications = state.allNotifications.filter(n => !n.isUserSpecific);
                }

                const unreadCount = relevantNotifications.filter(n => new Date(n.time) > new Date(lastCheckTime)).length;

                if (unreadCount > 0) {
                    countBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    countBadge.style.display = 'block';
                    notifButton.classList.add('shaking');
                } else {
                    countBadge.style.display = 'none';
                    notifButton.classList.remove('shaking');
                }
            }

            function loadNotifications() {
                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = '';
                
                let visibleNotifications = [...state.allNotifications];

                if (!state.currentUser) {
                    visibleNotifications = visibleNotifications.filter(n => !n.isUserSpecific);
                }

                const sortedNotifications = visibleNotifications.sort((a, b) => new Date(b.time) - new Date(a.time));

                if (sortedNotifications.length === 0) {
                    notificationList.innerHTML = '<p>You have no notifications</p>';
                } else {
                    sortedNotifications.forEach(notif => {
                        const deleteButton = notif.isUserSpecific || (notif.id && notif.id.startsWith('guest_feedback_'))
                            ? `<button class="delete-notification-btn" data-id="${notif.id}">&times;</button>` 
                            : '';
                        notificationList.innerHTML += `<div class="notification-item"><div class="notification-content">${notif.message}<small>${new Date(notif.time).toLocaleString()}</small></div>${deleteButton}</div>`;
                    });
                }
            }
            
            document.getElementById('notification-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-notification-btn')) {
                    e.stopPropagation();
                    const notificationId = e.target.getAttribute('data-id');
                    deleteUserNotification(notificationId);
                }
            });
            
            const liveChatBtn = document.getElementById('live-chat-btn');
            const chatMessagesContainer = document.getElementById('chat-messages');
            const chatTypingIndicatorArea = document.getElementById('chat-typing-indicator-area');
            const chatInputArea = document.getElementById('chat-input-area');
            const quickRepliesContainer = document.getElementById('chat-quick-replies');
            const chatRatingArea = document.getElementById('chat-rating-area');
            let chatState = {}; 
            let agentListener = null;

            liveChatBtn.addEventListener('click', (e) => { e.preventDefault(); showPage('support-chat'); initChat(); });

            function clearChatTimers() {
                if (chatState.agentBusyInterval) clearInterval(chatState.agentBusyInterval);
                if (chatState.timeoutAutoCloseTimer) clearTimeout(chatState.timeoutAutoCloseTimer);
                if(chatState.typingTimeout) clearTimeout(chatState.typingTimeout);
            }

            async function initChat() {
                chatMessagesContainer.innerHTML = '';
                clearChatTimers();
                resetChatUI();
                if (agentListener) agentListener.off();

                const savedChatId = localStorage.getItem('my_blood_liveChatId');
                if (savedChatId) {
                    const chatSnapshot = await database.ref(`live_chats/${savedChatId}`).once('value');
                    const chatData = chatSnapshot.val();
                    if (chatData && chatData.status !== 'closed_by_user' && chatData.status !== 'closed_by_agent' && chatData.status !== 'timed_out') {
                        restoreChatSession(savedChatId, chatData);
                        return;
                    }
                }
                
                localStorage.removeItem('my_blood_liveChatId');
                chatState = {
                    step: 'awaiting_name',
                    userName: state.currentUser ? state.currentUser.name : 'Guest',
                    userMobile: state.currentUser ? state.currentUser.mobile : '',
                    history: [],
                    liveChatId: null,
                    status: 'initializing',
                    menuStack: [],
                    agentBusyInterval: null,
                    busyMessageCount: 0,
                    timeoutAutoCloseTimer: null,
                    typingTimeout: null
                };
                
                if (state.currentUser) {
                     chatState.step = 'main_menu';
                     addMessageToChat(`ধন্যবাদ, ${chatState.userName}। আমরা কিভাবে আপনাকে সাহায্য করতে পারি?`, 'bot');
                     displayMainMenu();
                } else {
                     addMessageToChat('Team My Blood-এ আপনাকে স্বাগতম। আপনার নাম লিখুন।', 'bot');
                     renderTextInput('আপনার নাম...', handleChatInput);
                }
            }

            function restoreChatSession(chatId, chatData) {
                clearChatTimers();
                chatState = {
                    liveChatId: chatId,
                    userName: chatData.userName,
                    userMobile: chatData.userMobile,
                    status: chatData.status,
                    step: 'live_agent_chat',
                    history: chatData.initialHistory || [],
                    menuStack:[],
                    agentBusyInterval: null,
                    busyMessageCount: 0,
                    timeoutAutoCloseTimer: null,
                    typingTimeout: null
                };
                chatMessagesContainer.innerHTML = '';
                if (chatData.messages) {
                    Object.values(chatData.messages).forEach(msg => {
                        if (msg.type === 'event') {
                            addEventMessageToChat(msg.text, msg.subtext || '');
                        } else {
                            addMessageToChat(msg.text, msg.sender, msg.senderName);
                        }
                    });
                } else {
                    addMessageToChat('আপনার পূর্ববর্তী চ্যাটে আপনাকে আবার স্বাগতম।', 'bot');
                }

                if (chatData.status === 'pending') {
                    addEventMessageToChat(`প্রিয় ${chatState.userName}, আপনার মেসেজটি আমাদের কাছে খুবই গুরুত্বপূর্ণ।`, `Connecting An Agent`);
                    startAgentBusyInterval();
                }
                renderTextInput('আপনার বার্তা লিখুন...', handleChatInput);
                renderQuickReplies([{ label: 'চ্যাট ক্লোজ করুন', action: 'close_chat' }]);
                listenForAgentReplies();
            }
            
            function scrollToChatBottom() {
                setTimeout(() => { chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; }, 50);
            }

            function resetChatUI() {
                quickRepliesContainer.innerHTML = '';
                chatInputArea.innerHTML = '';
                chatTypingIndicatorArea.innerHTML = '';
                chatRatingArea.style.display = 'none';
                scrollToChatBottom();
            }
            
            function addMessageToChat(text, sender, senderName = 'Team My Blood') {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                const senderNameDiv = document.createElement('div');
                senderNameDiv.classList.add('sender-name');
                senderNameDiv.textContent = senderName;
                const messageText = document.createElement('div');
                messageText.innerHTML = text;
                messageDiv.appendChild(senderNameDiv);
                messageDiv.appendChild(messageText);
                chatMessagesContainer.appendChild(messageDiv);
                scrollToChatBottom();
                if (chatState.status !== 'initializing') {
                    chatState.history.push({ sender, text, senderName, timestamp: new Date().toISOString() });
                }
            }
            
            function addEventMessageToChat(text, subtext = '') {
                const eventDiv = document.createElement('div');
                eventDiv.classList.add('chat-event-message');
                eventDiv.innerHTML = text;
                if(subtext) {
                    const subtextDiv = document.createElement('div');
                    subtextDiv.classList.add('connecting-status');
                    subtextDiv.textContent = subtext;
                    eventDiv.appendChild(subtextDiv);
                }
                chatMessagesContainer.appendChild(eventDiv);
                scrollToChatBottom();
                 if (chatState.liveChatId) {
                    database.ref(`live_chats/${chatState.liveChatId}/messages`).push({ text: text, subtext: subtext, type: 'event', timestamp: firebase.database.ServerValue.TIMESTAMP });
                 }
            }

            function showTypingIndicator() {
                if (!document.getElementById('typing-indicator')) {
                    chatTypingIndicatorArea.innerHTML = `<div id="typing-indicator" class="typing-indicator">Agent is typing<span>...</span></div>`;
                    scrollToChatBottom();
                }
            }

            function hideTypingIndicator() {
                chatTypingIndicatorArea.innerHTML = '';
            }
            
            function disableChatInput() {
                const input = document.getElementById('chat-text-input');
                const button = document.getElementById('chat-send-btn');
                if (input) input.disabled = true;
                if (button) button.disabled = true;
            }

            function renderTextInput(placeholder, onSubmit) {
                chatInputArea.innerHTML = `<div class="chat-input-wrapper"><input type="text" id="chat-text-input" placeholder="${placeholder}"><button id="chat-send-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z"/></svg></button></div>`;
                const input = document.getElementById('chat-text-input');
                const sendBtn = document.getElementById('chat-send-btn');
                
                const sendFunction = () => {
                    const value = input.value;
                    if (value.trim()) onSubmit(value);
                    input.value = '';
                    if (chatState.liveChatId) {
                        database.ref(`live_chats/${chatState.liveChatId}/typing_status/user`).set(false);
                    }
                };

                sendBtn.onclick = sendFunction;
                input.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendFunction(); }};
                input.oninput = () => {
                    if (!chatState.liveChatId) return;
                    database.ref(`live_chats/${chatState.liveChatId}/typing_status/user`).set(true);
                    if (chatState.typingTimeout) clearTimeout(chatState.typingTimeout);
                    chatState.typingTimeout = setTimeout(() => {
                        database.ref(`live_chats/${chatState.liveChatId}/typing_status/user`).set(false);
                    }, 2000);
                };
                input.focus();
                scrollToChatBottom();
            }

            function renderQuickReplies(replies) {
                quickRepliesContainer.innerHTML = '';
                if (chatState.menuStack.length > 0 && chatState.status !== 'active' && chatState.status !== 'pending') {
                    if (chatState.menuStack.length > 1) {
                         replies.push({ label: 'পূর্বের মেনুতে যান', action: 'go_back', isBackButton: true });
                    }
                    replies.push({ label: 'মেইন মেনুতে যান', action: 'main_menu' });
                }
                replies.forEach(reply => {
                    const button = document.createElement('button'); button.classList.add('quick-reply');
                    if (reply.isBackButton) button.classList.add('back-btn');
                    button.textContent = reply.label; button.onclick = () => handleQuickReply(reply);
                    quickRepliesContainer.appendChild(button);
                });
                scrollToChatBottom();
            }

            function handleChatInput(value) {
                const trimmedValue = value.trim(); if (!trimmedValue) return;
                addMessageToChat(trimmedValue, 'user', chatState.userName || 'User');
                
                switch(chatState.step) {
                    case 'awaiting_name':
                        chatState.userName = trimmedValue; chatState.step = 'awaiting_mobile';
                        addMessageToChat('ধন্যবাদ। এখন আপনার ১১-সংখ্যার মোবাইল নম্বর লিখুন।', 'bot');
                        renderTextInput('আপনার মোবাইল নম্বর...', handleChatInput); break;
                    case 'awaiting_mobile':
                        if (!/^01[3-9][0-9]{8}$/.test(trimmedValue)) { addMessageToChat('সঠিক মোবাইল নাম্বার প্রদর্শন করুন। একটি বৈধ ১১-সংখ্যার বাংলাদেশি মোবাইল নম্বর দিন।', 'bot'); return; }
                        chatState.userMobile = trimmedValue; chatState.step = 'main_menu';
                        addMessageToChat(`ধন্যবাদ, ${chatState.userName}। আমরা কিভাবে আপনাকে সাহায্য করতে পারি?`, 'bot');
                        displayMainMenu(); break;
                    case 'live_agent_chat':
                        if (chatState.liveChatId) {
                            database.ref(`live_chats/${chatState.liveChatId}/messages`).push({ text: trimmedValue, sender: 'user', senderName: chatState.userName, timestamp: firebase.database.ServerValue.TIMESTAMP });
                        }
                        break;
                }
            }
            
            function handleQuickReply(payload) {
                if (payload.action !== 'go_back') { addMessageToChat(payload.label, 'user', chatState.userName); }
                resetChatUI();
                
                switch(payload.action) {
                    case 'main_menu': displayMainMenu(); break;
                    case 'account_services': displayAccountServicesMenu(); break;
                    case 'donation_services': displayDonationMenu(); break;
                    case 'edit_profile': startProfileEditFlow(); break;
                    case 'edit_field': promptForSingleFieldEdit(payload.field, chatState.verifiedUserForEdit); break;
                    case 'edit_all': displayProfileEditForm(chatState.verifiedUserForEdit); break;
                    case 'delete_profile': startProfileDeleteFlow(); break;
                    case 'change_password': startChangePasswordFlow(); break;
                    case 'donate_developer': renderChatPreGiftForm(); break;
                    case 'start_live_chat': startLiveChat(); break;
                    case 'close_chat': showRatingPrompt(); break;
                    case 'go_back':
                        chatState.menuStack.pop();
                        const previousMenu = chatState.menuStack[chatState.menuStack.length - 1];
                        const menuActions = { 'main_menu': displayMainMenu, 'account_services': displayAccountServicesMenu, 'donation_services': displayDonationMenu, 'edit_profile_verify': startProfileEditFlow, 'change_password': startChangePasswordFlow };
                        (menuActions[previousMenu] || displayMainMenu)(); break;
                }
            }

            function displayMainMenu() {
                chatState.step = 'main_menu'; chatState.menuStack = ['main_menu'];
                renderQuickReplies([ { label: 'একাউন্ট সেবা', action: 'account_services' }, { label: 'ডেভলপার ডোনেশন সেবা', action: 'donation_services' }, { label: 'এজেন্ট এর সাথে চ্যাট', action: 'start_live_chat' } ]);
            }
            
            function displayAccountServicesMenu() {
                 chatState.step = 'account_services_menu'; chatState.menuStack.push('account_services');
                 renderQuickReplies([ { label: 'প্রোফাইল এডিট', action: 'edit_profile' }, { label: 'প্রোফাইল ডিলিট', action: 'delete_profile' }, { label: 'পাসওয়ার্ড পরিবর্তন', action: 'change_password' } ]);
            }

            function displayDonationMenu() {
                chatState.step = 'donation_services_menu'; chatState.menuStack.push('donation_services');
                renderQuickReplies([ { label: 'ডোনেট ফর ডেভেলপার', action: 'donate_developer' }]);
            }

            function startProfileEditFlow() {
                chatState.menuStack.push('edit_profile_verify');
                addMessageToChat('আপনার প্রোফাইল এডিট করতে, অনুগ্রহ করে আপনার মোবাইল নম্বর/ইউজার আইডি এবং পাসওয়ার্ড দিয়ে পরিচয় যাচাই করুন।', 'bot');
                chatInputArea.innerHTML = `<form id="chat-verify-form" class="chat-form-compact"><div class="form-group"><label>মোবাইল নম্বর বা ইউজার আইডি</label><input type="text" id="chat-verify-id" required></div><div class="form-group"><label>পাসওয়ার্ড</label><input type="password" id="chat-verify-password" required></div><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">যাচাই করুন</button></div></form>`;
                document.getElementById('chat-verify-form').addEventListener('submit', handleProfileEditVerification);
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => displayAccountServicesMenu());
            }
            
            function handleProfileEditVerification(e) {
                e.preventDefault(); const loginId = document.getElementById('chat-verify-id').value; const password = document.getElementById('chat-verify-password').value;
                const user = state.allUsers.find(u => (u.mobile === loginId || u.id.toString() === loginId) && u.password === password);
                if (user) { chatState.verifiedUserForEdit = user; addMessageToChat('যাচাই সফল হয়েছে। আপনি কোন তথ্যটি এডিট করতে চান?', 'bot'); displayProfileEditMenu(user); }
                else { addMessageToChat('দুঃখিত, প্রদত্ত তথ্যের সাথে কোনো অ্যাকাউন্ট মেলেনি।', 'bot'); displayMainMenu(); }
            }
            
            function displayProfileEditMenu(user) {
                chatState.menuStack.push('edit_profile');
                renderQuickReplies([
                    { label: 'নাম', action: 'edit_field', field: 'name' }, { label: 'ব্লাড গ্রুপ', action: 'edit_field', field: 'bloodGroup' },
                    { label: 'জেলা', action: 'edit_field', field: 'district' }, { label: 'থানা', action: 'edit_field', field: 'thana' }, 
                    { label: 'লিঙ্গ', action: 'edit_field', field: 'gender' },
                    { label: 'শেষ রক্তদান', action: 'edit_field', field: 'lastDonation' }, { label: 'মোট রক্তদান', action: 'edit_field', field: 'totalDonations' },
                    { label: 'সকল তথ্য এডিট', action: 'edit_all' }
                ]);
            }
            
            function promptForSingleFieldEdit(field, user) {
                const fieldLabels = { name: 'নাম', bloodGroup: 'ব্লাড গ্রুপ', district: 'জেলা', thana: 'থানা', gender: 'লিঙ্গ', lastDonation: 'শেষ রক্তদান (YYYY-MM-DD)', totalDonations: 'মোট রক্তদান (সংখ্যা)' };
                let inputHtml = ''; const currentValue = user[field] || '';

                if (['name', 'lastDonation', 'totalDonations'].includes(field)) {
                    const type = field === 'lastDonation' ? 'date' : (field === 'totalDonations' ? 'number' : 'text');
                    const maxDate = field === 'lastDonation' ? `max="${new Date().toISOString().split('T')[0]}"` : '';
                    inputHtml = `<input type="${type}" id="chat-edit-single-field" value="${currentValue}" ${maxDate} required>`;
                } else if (field === 'bloodGroup') {
                    inputHtml = `<select id="chat-edit-single-field">${bloodGroups.map(bg => `<option value="${bg}" ${bg === currentValue ? 'selected' : ''}>${bg}</option>`).join('')}</select>`;
                } else if (field === 'district') {
                    inputHtml = `<select id="chat-edit-single-field">${districts.map(d => `<option value="${d}" ${d === currentValue ? 'selected' : ''}>${d}</option>`).join('')}</select>`;
                } else if (field === 'thana') {
                    const thanasForDistrict = thanaData[user.district] || [];
                    if(thanasForDistrict.length === 0) {
                        addMessageToChat('থানা পরিবর্তন করার আগে অনুগ্রহ করে জেলা নির্বাচন করুন।', 'bot');
                        displayProfileEditMenu(user);
                        return;
                    }
                    inputHtml = `<select id="chat-edit-single-field">${thanasForDistrict.map(t => `<option value="${t}" ${t === currentValue ? 'selected' : ''}>${t}</option>`).join('')}</select>`;
                } else if (field === 'gender') {
                     inputHtml = `<select id="chat-edit-single-field"><option value="Male" ${'Male' === currentValue ? 'selected' : ''}>Male</option><option value="Female" ${'Female' === currentValue ? 'selected' : ''}>Female</option></select>`;
                }
                
                chatInputArea.innerHTML = `<form id="chat-edit-single-form" class="chat-form-compact"><div class="form-group"><label>${fieldLabels[field]}</label>${inputHtml}</div><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">আপডেট</button></div></form>`;
                
                document.getElementById('chat-edit-single-form').addEventListener('submit', (e) => {
                    e.preventDefault(); const newValue = document.getElementById('chat-edit-single-field').value;
                    const updatePayload = { [field]: newValue };
                    
                    if(field === 'district' && newValue !== user.district) {
                        updatePayload.thana = ''; 
                    }
                    database.ref('users/' + user.mobile).update(updatePayload).then(() => {
                        addMessageToChat(`${fieldLabels[field]} সফলভাবে আপডেট করা হয়েছে।`, 'bot'); addNotification(user.id, `Your ${field} was updated to "${newValue}".`);
                        database.ref('users/' + user.mobile).once('value', snapshot => { 
                            chatState.verifiedUserForEdit = snapshot.val(); 
                            displayProfileEditMenu(chatState.verifiedUserForEdit); 
                        });
                    });
                });
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => displayProfileEditMenu(user));
            }
            
            function displayProfileEditForm(user) {
                addMessageToChat('আপনার সকল তথ্য একসাথে এডিট করুন।', 'bot');
                chatInputArea.innerHTML = `
                    <form id="chat-edit-all-form" class="chat-form-compact" style="max-height: 250px; overflow-y: auto;">
                        <div class="form-group"><label>নাম</label><input type="text" id="chat-edit-name" value="${user.name}" required></div>
                        <div class="form-group"><label>মোবাইল</label><input type="tel" value="${user.mobile}" readonly title="Mobile number cannot be changed here."></div>
                        <div class="form-group"><label>ব্লাড গ্রুপ</label><select id="chat-edit-blood-group" required></select></div>
                        <div class="form-group"><label>জেলা</label><select id="chat-edit-district" required></select></div>
                        <div class="form-group"><label>থানা</label><select id="chat-edit-thana" required></select></div>
                        <div class="form-group"><label>লিঙ্গ</label><select id="chat-edit-gender"></select></div>
                        <div class="form-group"><label>শেষ রক্তদান</label><input type="date" id="chat-edit-lastDonation" value="${user.lastDonation || ''}"></div>
                        <div class="form-group"><label>মোট রক্তদান</label><input type="number" id="chat-edit-totalDonations" value="${user.totalDonations || 0}"></div>
                        <div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">আপডেট করুন</button></div>
                    </form>`;
                
                const districtSelect = document.getElementById('chat-edit-district');
                const thanaSelect = document.getElementById('chat-edit-thana');

                populateBloodGroups(document.getElementById('chat-edit-blood-group'));
                populateSelectWithOptions(districtSelect, districts);
                populateSelectWithOptions(document.getElementById('chat-edit-gender'), ['Male', 'Female']);
                
                document.getElementById('chat-edit-blood-group').value = user.bloodGroup;
                districtSelect.value = user.district;
                document.getElementById('chat-edit-gender').value = user.gender;

                populateThanas(user.district, thanaSelect, null);
                thanaSelect.value = user.thana;
                
                districtSelect.addEventListener('change', () => {
                    populateThanas(districtSelect.value, thanaSelect, null);
                });

                document.getElementById('chat-edit-lastDonation').max = new Date().toISOString().split("T")[0];
                document.getElementById('chat-edit-all-form').addEventListener('submit', (e) => handleProfileEditSubmit(e, user));
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => displayProfileEditMenu(user));
            }

            function handleProfileEditSubmit(e, user) {
                e.preventDefault(); const form = e.target;
                const updatedData = {
                    name: form.querySelector('#chat-edit-name').value, 
                    bloodGroup: form.querySelector('#chat-edit-blood-group').value,
                    district: form.querySelector('#chat-edit-district').value, 
                    thana: form.querySelector('#chat-edit-thana').value, 
                    gender: form.querySelector('#chat-edit-gender').value,
                    lastDonation: form.querySelector('#chat-edit-lastDonation').value || null, 
                    totalDonations: parseInt(form.querySelector('#chat-edit-totalDonations').value) || 0,
                };
                database.ref('users/' + user.mobile).update(updatedData).then(() => {
                    addMessageToChat('আপনার প্রোফাইল সফলভাবে আপডেট করা হয়েছে।', 'bot'); addNotification(user.id, 'Your profile (all info) was updated via live chat.');
                    displayMainMenu();
                });
            }
            
            function startProfileDeleteFlow() {
                addMessageToChat('আপনার প্রোফাইল ডিলিট করতে, অনুগ্রহ করে আপনার মোবাইল নম্বর/ইউজার আইডি এবং পাসওয়ার্ড দিন।', 'bot');
                chatInputArea.innerHTML = `<form id="chat-delete-form" class="chat-form-compact"><div class="form-group"><label>মোবাইল নম্বর বা ইউজার আইডি</label><input type="text" id="chat-delete-id" required></div><div class="form-group"><label>পাসওয়ার্ড</label><input type="password" id="chat-delete-password" required></div><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">ডিলিট করুন</button></div></form>`;
                document.getElementById('chat-delete-form').addEventListener('submit', handleDeleteProfileSubmit);
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => displayAccountServicesMenu());
            }

            function handleDeleteProfileSubmit(e) {
                e.preventDefault(); const loginId = document.getElementById('chat-delete-id').value; const password = document.getElementById('chat-delete-password').value;
                const user = state.allUsers.find(u => (u.mobile === loginId || u.id.toString() === loginId) && u.password === password);
                if (user) {
                    if (confirm(`আপনি কি নিশ্চিত যে আপনি ${user.mobile} নম্বরের অ্যাকাউন্টটি ডিলিট করতে চান?`)) {
                        database.ref('users/' + user.mobile).remove().then(() => {
                            addMessageToChat(`আপনার অ্যাকাউন্ট (${user.mobile}) সফলভাবে ডিলিট করা হয়েছে।`, 'bot'); addNotification(user.id, 'Your account has been deleted as per your request.');
                            displayMainMenu();
                        });
                    } else { addMessageToChat('অ্যাকাউন্ট ডিলিট বাতিল করা হয়েছে।', 'bot'); displayAccountServicesMenu(); }
                } else { addMessageToChat('দুঃখিত, প্রদত্ত তথ্যের সাথে কোনো অ্যাকাউন্ট মেলেনি।', 'bot'); displayAccountServicesMenu(); }
            }
            
            function startChangePasswordFlow() {
                chatState.menuStack.push('change_password');
                addMessageToChat('আপনার পাসওয়ার্ড পরিবর্তন করতে, অনুগ্রহ করে নিচের তথ্যগুলো পূরণ করুন।', 'bot');
                chatInputArea.innerHTML = `<form id="chat-password-form" class="chat-form-compact"><div class="form-group"><label>মোবাইল নম্বর বা ইউজার আইডি</label><input type="text" id="chat-pw-id" required></div><div class="form-group"><label>পুরাতন পাসওয়ার্ড</label><input type="password" id="chat-pw-old" required></div><div class="form-group"><label>নতুন পাসওয়ার্ড</label><input type="password" id="chat-pw-new" required minlength="5"></div><a class="chat-form-link" id="chat-forgot-pw-link">ফরগেট পাসওয়ার্ড?</a><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">পাসওয়ার্ড পরিবর্তন করুন</button></div></form>`;
                document.getElementById('chat-password-form').addEventListener('submit', handleChangePasswordSubmit);
                document.getElementById('chat-forgot-pw-link').addEventListener('click', startForgotPasswordFlow);
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => displayAccountServicesMenu());
            }

            function handleChangePasswordSubmit(e) {
                e.preventDefault(); const loginId = document.getElementById('chat-pw-id').value; const oldPassword = document.getElementById('chat-pw-old').value; const newPassword = document.getElementById('chat-pw-new').value;
                const user = state.allUsers.find(u => (u.mobile === loginId || u.id.toString() === loginId) && u.password === oldPassword);
                if (user) {
                    database.ref('users/' + user.mobile + '/password').set(newPassword).then(() => {
                        addMessageToChat('আপনার পাসওয়ার্ড সফলভাবে পরিবর্তন করা হয়েছে।', 'bot'); addNotification(user.id, 'Your password was changed successfully.');
                        displayMainMenu();
                    });
                } else { addMessageToChat('দুঃখিত, আপনার মোবাইল নম্বর বা পুরাতন পাসওয়ার্ড সঠিক নয়।', 'bot'); displayAccountServicesMenu(); }
            }

            function startForgotPasswordFlow() {
                 addMessageToChat('পাসওয়ার্ড পুনরুদ্ধার করতে, আপনার মোবাইল নম্বর এবং পুরাতন পাসওয়ার্ডের শেষ তিনটি সংখ্যা দিন।', 'bot');
                chatInputArea.innerHTML = `<form id="chat-forgot-pw-form" class="chat-form-compact"><div class="form-group"><label>মোবাইল নম্বর বা ইউজার আইডি</label><input type="text" id="chat-forgot-id" required></div><div class="form-group"><label>পুরাতন পাসওয়ার্ড এর লাস্ট ৩ সংখ্যা</label><input type="text" id="chat-forgot-last3" required maxlength="3"></div><a class="chat-form-link" id="chat-fully-forgot-link">সম্পূর্ণ পাসওয়ার্ড ভুলে গেছেন?</a><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">সাবমিট</button></div></form>`;
                document.getElementById('chat-forgot-pw-form').addEventListener('submit', handleForgotPasswordVerification);
                document.getElementById('chat-fully-forgot-link').addEventListener('click', handleFullyForgotPassword);
                chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => startChangePasswordFlow());
            }

            function handleForgotPasswordVerification(e){
                e.preventDefault(); const loginId = document.getElementById('chat-forgot-id').value; const lastThree = document.getElementById('chat-forgot-last3').value;
                const user = state.allUsers.find(u => (u.mobile === loginId || u.id.toString() === loginId));
                if (user && user.password && user.password.slice(-3) === lastThree) {
                    addMessageToChat('যাচাই সফল হয়েছে। আপনার নতুন পাসওয়ার্ড সেট করুন।', 'bot');
                    chatInputArea.innerHTML = `<form id="chat-reset-pw-form" class="chat-form-compact"><div class="form-group"><label>New Password</label><input type="password" id="chat-reset-new-pw" required minlength="5"></div><div class="form-actions"><button type="button" class="btn btn-cancel">Cancel</button><button type="submit" class="btn">সেট করুন</button></div></form>`;
                    document.getElementById('chat-reset-pw-form').addEventListener('submit', (ev) => {
                        ev.preventDefault(); const newPassword = document.getElementById('chat-reset-new-pw').value;
                        database.ref('users/' + user.mobile + '/password').set(newPassword).then(() => {
                            addMessageToChat('আপনার পাসওয়ার্ড সফলভাবে রিসেট করা হয়েছে।', 'bot'); addNotification(user.id, 'Your password was reset via forgot password option.');
                            displayMainMenu();
                        });
                    });
                    chatInputArea.querySelector('.btn-cancel').addEventListener('click', () => startForgotPasswordFlow());
                } else { addMessageToChat('দুঃখিত, আপনার দেওয়া তথ্য সঠিক নয়।', 'bot'); displayAccountServicesMenu(); }
            }

            function handleFullyForgotPassword() {
                addMessageToChat('পাসওয়ার্ড পুনরুদ্ধারে সহায়তার জন্য অনুগ্রহ করে আমাদের এজেন্টের সাথে কথা বলুন।', 'bot');
                resetChatUI(); renderQuickReplies([{ label: 'এজেন্ট এর সাথে চ্যাট', action: 'start_live_chat' }]);
            }
            
            function renderChatPreGiftForm() {
                resetChatUI();
                const formWrapper = document.createElement('div');
                formWrapper.classList.add('message', 'bot');
                formWrapper.innerHTML = `
                    <div class="sender-name">Team My Blood</div>
                    <div class="chat-donation-steps">
                        <p>অ্যাপ উন্নতি ও ডেভেলপারের কাজের জন্য নিম্নোক্ত নাম্বারে Send Money করুন।</p>
                        <div class="dev-number">01323491257</div>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="chat-confirm-send-money">
                            <label for="chat-confirm-send-money">আপনি কি নিশ্চিত সেন্ড মানি করবেন? Send Money করতে টিক বক্সে টিক দিয়ে নাম্বার টি কপি করে আপনার মোবাইল ব্যাংকিং থেকে অনুদান পাঠান।</label>
                        </div>

                        <button type="button" class="btn" id="chat-copy-dev-num" style="width: auto; padding: 8px 15px; margin: 5px auto; display: block; background-color: #3498db; font-size: 0.9rem;" disabled>নম্বর কপি করুন</button>
                        <p class="copy-message">দয়া করে কপি করা নাম্বারটিতে আপনার বিকাশ/নগদ/রকেট Send Money করুন। এবং নিচের বক্সে Transaction Id টি দিন। ধন্যবাদ</p>
                        
                        <div class="checkbox-group">
                            <input type="checkbox" id="chat-confirm-donation-done" disabled>
                            <label for="chat-confirm-donation-done">আপনি কি ডোনেশন করেছেন? করলে টিক মার্ক দিন।</label>
                        </div>

                        <div class="form-group" style="padding: 0 10px;">
                            <label for="chat-pre-gift-trx">Send Money Transaction Id Or Sender Mobile Number</label>
                            <input type="text" id="chat-pre-gift-trx" required disabled>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-cancel">Cancel</button>
                            <button type="button" class="btn" id="chat-gift-next-btn" disabled>Next</button>
                        </div>
                    </div>`;
                chatMessagesContainer.appendChild(formWrapper);
                scrollToChatBottom();

                const confirmSend = formWrapper.querySelector('#chat-confirm-send-money');
                const copyBtn = formWrapper.querySelector('#chat-copy-dev-num');
                const copyMsg = formWrapper.querySelector('.copy-message');
                const confirmDone = formWrapper.querySelector('#chat-confirm-donation-done');
                const trxInput = formWrapper.querySelector('#chat-pre-gift-trx');
                const nextBtn = formWrapper.querySelector('#chat-gift-next-btn');

                confirmSend.addEventListener('change', () => {
                    copyBtn.disabled = !confirmSend.checked;
                    if (!confirmSend.checked) {
                        confirmDone.checked = false; confirmDone.disabled = true;
                        trxInput.value = ''; trxInput.disabled = true;
                        nextBtn.disabled = true; copyMsg.style.display = 'none';
                    }
                });
                
                copyBtn.addEventListener('click', () => {
                     fallbackCopyTextToClipboard('01323491257', () => {
                        copyBtn.textContent = 'কপি হয়েছে!';
                        copyMsg.style.display = 'block';
                        confirmDone.disabled = false;
                        setTimeout(() => { copyBtn.textContent = 'নম্বর কপি করুন'; }, 2000);
                     });
                });

                confirmDone.addEventListener('change', () => {
                    trxInput.disabled = !confirmDone.checked;
                    if(!confirmDone.checked) nextBtn.disabled = true;
                    trxInput.dispatchEvent(new Event('input'));
                });

                trxInput.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^a-zA-Z0-9-]/g, '');
                    nextBtn.disabled = !(trxInput.value.trim() && confirmDone.checked);
                });
                
                nextBtn.addEventListener('click', () => {
                    state.preGiftTrxId = trxInput.value;
                    formWrapper.remove();
                    displayChatDonationForm();
                });
                
                formWrapper.querySelector('.btn-cancel').addEventListener('click', () => {
                    formWrapper.remove();
                    displayDonationMenu();
                });
            }


            function displayChatDonationForm() {
                const formWrapper = document.createElement('div');
                formWrapper.classList.add('message', 'bot', 'donation-form-wrapper');
                formWrapper.innerHTML = `
                    <div class="sender-name">Team My Blood</div>
                    <form id="chat-donation-form" class="chat-form-compact" style="max-height: 250px; overflow-y: auto;">
                        <p style="text-align:center; font-size:0.9rem; margin-top:0;">অ্যাপ উন্নতি বা ডেভেলপার কে হাদিয়া পাঠানোর জন্য ধন্যবাদ, দয়া করে নিচের তথ্যগুলো পূরণ করুন।</p>
                        <div class="form-group"><label for="chat-gift-name">আপনার নাম</label><input type="text" id="chat-gift-name" value="${state.currentUser ? state.currentUser.name : ''}" required></div>
                        <div class="form-group"><label for="chat-gift-mobile">আপনার মোবাইল</label><input type="tel" id="chat-gift-mobile" value="${state.currentUser ? state.currentUser.mobile : ''}" required pattern="01[3-9][0-9]{8}"></div>
                        <div class="form-group"><label for="chat-gift-address">আপনার ঠিকানা</label><input type="text" id="chat-gift-address" required></div>
                        <div class="form-group"><label for="chat-gift-reason">উপহারের কারণ</label><textarea id="chat-gift-reason" rows="2" required></textarea></div>
                        <div class="form-group"><label for="chat-gift-amount">Amount</label><input type="text" id="chat-gift-amount" inputmode="numeric" pattern="[0-9]*" required placeholder="শুধুমাত্র ইংরেজি সংখ্যায় লিখুন"></div>
                        <div class="form-group"><label>যে মাধ্যমে পাঠাতে চান</label><div class="payment-options" id="chat-payment-options"></div></div>
                        <div class="form-group"><label for="chat-gift-trx-digits">যে নাম্বার থেকে হাদিয়া পাঠিয়েছেন তার লাস্ট ৩ সংখ্যা</label><input type="text" id="chat-gift-trx-digits" required maxlength="3" pattern="[0-9]{3}"></div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-cancel">Cancel</button>
                            <button type="submit" class="btn btn-submit-special">সাবমিট করুন</button>
                        </div>
                    </form>`;
                
                const paymentOptionsContainer = formWrapper.querySelector('#chat-payment-options');
                ['bKash', 'Nagad', 'Rocket'].forEach((method, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'payment-option';
                    const radioId = `chat-${method.toLowerCase()}`;
                    optionDiv.innerHTML = `<input type="radio" id="${radioId}" name="chat_payment_method" value="${method}" ${index === 0 ? 'checked' : ''}><label for="${radioId}"><span>${method}</span></label>`;
                    paymentOptionsContainer.appendChild(optionDiv);
                });

                chatMessagesContainer.appendChild(formWrapper);
                
                formWrapper.querySelector('#chat-gift-amount').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
                
                formWrapper.querySelector('.btn-cancel').addEventListener('click', () => {
                    formWrapper.remove();
                    displayDonationMenu();
                });
                formWrapper.querySelector('#chat-donation-form').addEventListener('submit', handleDonationSubmit);
                scrollToChatBottom();
            }

            function handleDonationSubmit(e) {
                e.preventDefault(); const form = e.currentTarget;
                 
                const finalLastThree = form.querySelector('#chat-gift-trx-digits').value;
                const initialInput = state.preGiftTrxId;
                if (/^01[3-9][0-9]{8}$/.test(initialInput)) {
                    const initialLastThree = initialInput.slice(-3);
                    if (initialLastThree !== finalLastThree) {
                        addMessageToChat("আপনি পূর্বে যে মোবাইল নম্বরটি দিয়েছেন তার শেষের ৩ সংখ্যার সাথে এই সংখ্যা মিলছে না।", 'bot');
                        return;
                    }
                }

                const giftData = {
                    name: form.querySelector('#chat-gift-name').value, 
                    mobile: form.querySelector('#chat-gift-mobile').value,
                    address: form.querySelector('#chat-gift-address').value,
                    reason: form.querySelector('#chat-gift-reason').value,
                    giftAmount: parseInt(form.querySelector('#chat-gift-amount').value, 10),
                    paymentMethod: form.querySelector('input[name="chat_payment_method"]:checked').value,
                    last3Digits: finalLastThree,
                    transactionInfo: state.preGiftTrxId,
                    date: new Date().toISOString()
                };
                database.ref('gifts').push(giftData).then(() => {
                    addMessageToChat(`ধন্যবাদ প্রিয় ${giftData.name}, আপনার অনুদান পাঠিয়ে আমাদেরকে সহায়তা করার জন্য।`, 'bot');
                    const userAccount = state.allUsers.find(u => u.mobile === giftData.mobile);
                    if (userAccount) { addNotification(userAccount.id, `Thank you for your generous gift, ${giftData.name}!`); }
                    state.preGiftTrxId = null;
                    displayMainMenu();
                });
            }

            function startLiveChat() {
                chatState.step = 'live_agent_chat'; chatState.status = 'pending';
                addEventMessageToChat(`প্রিয় ${chatState.userName}, আপনার মেসেজটি আমাদের কাছে খুবই গুরুত্বপূর্ণ। কিছুক্ষনের মধ্যে একজন এজেন্ট আপনার মেসেজের রিপ্লাই দিবেন। ধন্যবাদ`, `Connecting An Agent`);
                renderTextInput('আপনার বার্তা লিখুন...', handleChatInput);
                renderQuickReplies([{ label: 'চ্যাট ক্লোজ করুন', action: 'close_chat' }]);
                
                const newChatRef = database.ref('live_chats').push();
                chatState.liveChatId = newChatRef.key;
                localStorage.setItem('my_blood_liveChatId', chatState.liveChatId);
                
                newChatRef.set({
                    userName: chatState.userName,
                    userMobile: chatState.userMobile,
                    initialHistory: chatState.history,
                    status: 'pending',
                    startTime: firebase.database.ServerValue.TIMESTAMP,
                    typing_status: { user: false, agent: false }
                });

                listenForAgentReplies();
                startAgentBusyInterval();
            }

            function handleChatTimeout() {
                addEventMessageToChat(`দুঃখিত প্রিয় ${chatState.userName}, এই মুহুর্তে কোনো এজেন্ট কে কানেক্ট করা সম্ভব হয়নি। দয়া করে পরে আবার যোগাযোগ করুন। ধন্যবাদ`);
                disableChatInput();
                renderQuickReplies([{ label: 'চ্যাট ক্লোজ করুন', action: 'close_chat' }]);
                if (chatState.liveChatId) {
                    database.ref(`live_chats/${chatState.liveChatId}/status`).set('timed_out');
                }
                
                chatState.timeoutAutoCloseTimer = setTimeout(() => {
                    const chatPage = document.getElementById('support-chat-page');
                    if (chatPage.classList.contains('active')) {
                         showRatingPrompt();
                    }
                }, 120000);
            }

            function startAgentBusyInterval() {
                clearChatTimers();
                chatState.busyMessageCount = 0;
                chatState.agentBusyInterval = setInterval(() => {
                    if (chatState.status === 'pending') {
                        chatState.busyMessageCount++;
                        if (chatState.busyMessageCount <= 3) {
                            addEventMessageToChat('এই মুহুর্তে আমাদের সকল এজেন্ট ব্যস্ত আছেন। দয়া করে আরও কিছুক্ষণ অপেক্ষা করুন', 'Connecting An Agent');
                        }
                        if (chatState.busyMessageCount === 3) {
                            clearInterval(chatState.agentBusyInterval);
                            handleChatTimeout();
                        }
                    } else {
                        clearInterval(chatState.agentBusyInterval);
                    }
                }, 60000);
            }
            
            function listenForAgentReplies() {
                if (!chatState.liveChatId) return;
                const chatRef = database.ref(`live_chats/${chatState.liveChatId}`);

                if(agentListener) agentListener.off(); 
                agentListener = chatRef;

                chatRef.child('messages').on('child_added', msgSnapshot => {
                    const message = msgSnapshot.val();
                    if (message.sender === 'agent' && !document.getElementById(msgSnapshot.key)) {
                        addMessageToChat(message.text, 'bot', message.senderName || 'Team My Blood');
                        const msgElement = chatMessagesContainer.lastChild; if(msgElement) msgElement.id = msgSnapshot.key;
                    }
                });

                chatRef.on('value', snapshot => {
                    const chatData = snapshot.val();
                    if(!chatData) return;

                    if (chatData.status === 'active' && chatState.status === 'pending') {
                         clearChatTimers();
                         chatState.status = 'active';
                         addEventMessageToChat('An Agent Joined This Chat');
                    }
                    
                    if (chatData.status === 'closed_by_agent' && chatState.status !== 'closed_by_agent') {
                        chatState.status = 'closed_by_agent';
                        clearChatTimers();
                        hideTypingIndicator();
                        addEventMessageToChat('চ্যাট সেশন টি এজেন্ট দ্বারা ক্লোজ করা হয়েছে। দয়া করে পরে আবার যোগাযোগ করুন। ধন্যবাদ');
                        localStorage.removeItem('my_blood_liveChatId');
                        resetChatUI();
                        setTimeout(initChat, 5000);
                    }

                    if (chatData.typing_status && chatData.typing_status.agent) {
                        showTypingIndicator();
                    } else {
                        hideTypingIndicator();
                    }
                });
            }
            
            function showRatingPrompt() {
                clearChatTimers();
                resetChatUI();
                chatRatingArea.style.display = 'block';
                const stars = document.querySelectorAll('#rating-stars .star');
                const emojiDiv = document.getElementById('rating-emoji');
                const submitBtn = document.getElementById('submit-rating-btn');
                let selectedRating = 0;
                const emojis = ['😠', '😐', '🙁', '🙂', '😍'];

                stars.forEach(star => {
                    const clickHandler = () => {
                        selectedRating = parseInt(star.dataset.value);
                        submitBtn.disabled = false;
                        emojiDiv.textContent = emojis[selectedRating - 1];
                        stars.forEach(s => s.classList.toggle('selected', parseInt(s.dataset.value) <= selectedRating));
                    };
                    star.addEventListener('mouseover', () => {
                        const hoverValue = parseInt(star.dataset.value);
                        stars.forEach(s => s.classList.toggle('hovered', parseInt(s.dataset.value) <= hoverValue));
                    });
                    star.addEventListener('mouseout', () => stars.forEach(s => s.classList.remove('hovered')));
                    star.addEventListener('click', clickHandler);
                });

                submitBtn.onclick = () => {
                    const finalStatus = chatState.status === 'timed_out' ? 'timed_out' : 'closed_by_user';
                    if (chatState.liveChatId) {
                        database.ref(`live_chats/${chatState.liveChatId}`).update({ status: finalStatus, rating: selectedRating, rating_emoji: emojis[selectedRating - 1], endTime: firebase.database.ServerValue.TIMESTAMP });
                    }
                    addMessageToChat('আপনার মূল্যবান মতামতের জন্য ধন্যবাদ।', 'bot');
                    localStorage.removeItem('my_blood_liveChatId');
                    setTimeout(initChat, 2000);
                };
            }
            
            // MODIFICATION: Simplified Update Logic based on database changes
            function listenForAppUpdate() {
                const updateNotifRef = database.ref('admin_notifications/system_update_notification');
                database.ref('app_update_info').on('value', (snapshot) => {
                    const updateData = snapshot.val();
                    if (updateData && updateData.versionCode > APP_VERSION_CODE) {
                        const notificationMessage = `A new version (${updateData.versionName}) is available! <a href="${updateData.updateUrl}" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: underline;">Update Now</a>`;
                        updateNotifRef.set({
                            message: notificationMessage,
                            time: new Date().toISOString()
                        });
                    } else {
                        updateNotifRef.remove();
                    }
                });
            }
            
            function listenForAdminNotifications() {
                 database.ref('admin_notifications').on('value', snapshot => {
                    const adminNotifs = []; 
                    snapshot.forEach(child => { 
                        adminNotifs.push({ id: child.key, ...child.val() }); 
                    });
                    const userAndGuestNotifs = state.allNotifications.filter(n => n.isUserSpecific || (n.id && n.id.startsWith('guest_feedback_')));
                    state.allNotifications = [...adminNotifs, ...userAndGuestNotifs]; 
                    
                    updateNotificationCount();
                    if (notificationPanel.classList.contains('show')) {
                        loadNotifications();
                    }
                });
            }

            function listenForUserSpecificNotifications() {
                if(!state.currentUser) return;
                database.ref('user_notifications/' + state.currentUser.id).orderByChild('time').limitToLast(20).on('value', snapshot => {
                    const userNotifs = []; 
                    snapshot.forEach(child => { 
                        userNotifs.push({ id: child.key, ...child.val(), isUserSpecific: true }); 
                    });
                    const nonUserSpecificNotifs = state.allNotifications.filter(n => !n.isUserSpecific);
                    state.allNotifications = [...nonUserSpecificNotifs, ...userNotifs];
                     
                    updateNotificationCount();
                     if (notificationPanel.classList.contains('show')) {
                        loadNotifications();
                    }
                });
            }
            
            function loadMarqueeNotice() {
                database.ref('marquee_notice/text').on('value', snapshot => {
                    const noticeText = snapshot.val(); 
                    const noticeContainer = document.getElementById('notice-bar-container'); 
                    const noticeMarquee = document.getElementById('notice-bar-text');
                    if (noticeText && noticeText.trim() !== '') {
                        noticeMarquee.textContent = noticeText; 
                        noticeContainer.style.display = 'flex';
                    } else { 
                        noticeContainer.style.display = 'none'; 
                    }
                });
            }
            
            function showInitialAgreement() {
                const agreementModal = document.getElementById('agreement-modal');
                const agreeBtn = document.getElementById('agree-btn');
                const agreementCheckbox = document.getElementById('initial-agreement-checkbox');
                const socialJoinModal = document.getElementById('social-join-modal');

                if (!sessionStorage.getItem('myBloodAgreementAccepted')) {
                    agreementModal.style.display = 'flex';
                }

                agreementCheckbox.addEventListener('change', () => {
                    agreeBtn.disabled = !agreementCheckbox.checked;
                });

                agreeBtn.addEventListener('click', () => {
                    agreementModal.style.display = 'none';
                    sessionStorage.setItem('myBloodAgreementAccepted', 'true');
                    
                    setTimeout(() => {
                        socialJoinModal.style.display = 'flex';
                    }, 500);
                });
            }

            function createAnimatedBackground() {
                const backgroundContainer = document.getElementById('animated-background');
                const bloodGroupsForAnim = ['A+', 'B+', 'O+', 'AB+', 'A-', 'B-', 'O-', 'AB-'];
                const numberOfDrops = 30; 

                for (let i = 0; i < numberOfDrops; i++) {
                    const drop = document.createElement('div');
                    drop.classList.add('blood-drop-animated');
                    
                    const size = Math.random() * 30 + 20; 
                    drop.style.width = `${size}px`;
                    drop.style.height = `${size}px`;
                    drop.style.left = `${Math.random() * 100}vw`;
                    drop.style.animationDuration = `${Math.random() * 15 + 10}s`; 
                    drop.style.animationDelay = `${Math.random() * 10}s`; 
                    drop.style.fontSize = `${size / 4}px`; 
                    drop.textContent = bloodGroupsForAnim[Math.floor(Math.random() * bloodGroupsForAnim.length)];

                    backgroundContainer.appendChild(drop);
                }
            }
            
            const darkModeSwitch = document.getElementById('dark-mode-switch');

            function applyTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                darkModeSwitch.checked = theme === 'dark';
            }

            darkModeSwitch.addEventListener('change', () => {
                const newTheme = darkModeSwitch.checked ? 'dark' : 'light';
                localStorage.setItem('myBloodTheme', newTheme);
                applyTheme(newTheme);
            });
            
            // --- START: Banner Slider Logic ---
            function initializeBannerSlider() {
                const container = document.getElementById('banner-slider-container');
                const slidesContainer = container.querySelector('.banner-slides');
                const dotsContainer = container.querySelector('.banner-dots');
                let slides = [];
                let dots = [];
                let currentIndex = 0;
                let slideInterval;
                let touchStartX = 0;
                let touchEndX = 0;

                database.ref('banners').on('value', snapshot => {
                    const banners = snapshot.val();
                    if (!banners) {
                        container.style.display = 'none';
                        return;
                    }

                    slidesContainer.innerHTML = '';
                    dotsContainer.innerHTML = '';
                    const bannerData = Object.values(banners);

                    if (bannerData.length === 0) {
                        container.style.display = 'none';
                        return;
                    }

                    bannerData.forEach((banner, index) => {
                        slidesContainer.innerHTML += `
                            <div class="banner-slide">
                                <a href="${banner.targetUrl}" target="_blank">
                                    <img src="${banner.imageUrl}" alt="Banner ${index + 1}">
                                </a>
                            </div>`;
                        dotsContainer.innerHTML += `<div class="banner-dot" data-index="${index}"></div>`;
                    });

                    slides = container.querySelectorAll('.banner-slide');
                    dots = container.querySelectorAll('.banner-dot');
                    
                    if (slides.length > 0) {
                        container.style.display = 'block';
                        setupSlider();
                    }
                });

                function setupSlider() {
                    if (slides.length <= 1) {
                        dotsContainer.style.display = 'none';
                    }
                    
                    updateSlider();
                    startAutoSlide();

                    dots.forEach(dot => {
                        dot.addEventListener('click', () => {
                            currentIndex = parseInt(dot.dataset.index);
                            updateSlider();
                            resetAutoSlide();
                        });
                    });
                    
                    container.addEventListener('touchstart', handleTouchStart);
                    container.addEventListener('touchmove', handleTouchMove);
                    container.addEventListener('touchend', handleTouchEnd);
                }

                function updateSlider() {
                    slidesContainer.style.transform = `translateX(-${currentIndex * 100}%)`;
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }
                
                function startAutoSlide() {
                    if (slides.length <= 1) return;
                    stopAutoSlide();
                    slideInterval = setInterval(() => {
                        currentIndex = (currentIndex + 1) % slides.length;
                        updateSlider();
                    }, 5000);
                }

                function stopAutoSlide() {
                    clearInterval(slideInterval);
                }
                
                function resetAutoSlide() {
                    stopAutoSlide();
                    startAutoSlide();
                }
                
                function handleTouchStart(e) {
                    touchStartX = e.touches[0].clientX;
                    stopAutoSlide();
                }

                function handleTouchMove(e) {
                    touchEndX = e.touches[0].clientX;
                }

                function handleTouchEnd() {
                    const diff = touchStartX - touchEndX;
                    if (Math.abs(diff) > 50) { // Threshold for swipe
                        if (diff > 0) { // Swiped left
                            currentIndex = (currentIndex + 1) % slides.length;
                        } else { // Swiped right
                            currentIndex = (currentIndex - 1 + slides.length) % slides.length;
                        }
                        updateSlider();
                    }
                    startAutoSlide();
                }
            }
            // --- END: Banner Slider Logic ---


            // --- START: MODIFIED SOCIAL FEED LOGIC ---
            function showSocialFeed() {
                if (socialFeedPage.classList.contains('active')) return;
                socialFeedPage.classList.add('active');
                history.pushState({ page: 'social-feed' }, '', '#social-feed');
                fetchAndRenderPosts();
            }

            function hideSocialFeed() {
                if (!socialFeedPage.classList.contains('active')) return;
                socialFeedPage.classList.remove('active');
            }

            function getUniqueVisitorId() {
                let visitorId = localStorage.getItem('myBloodGuestId');
                if (!visitorId) {
                    visitorId = 'guest_' + new Date().getTime() + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('myBloodGuestId', visitorId);
                }
                return visitorId;
            }
            
            // NEW: Shuffle function for randomizing posts
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function fetchAndRenderPosts() {
                const postsRef = database.ref('social_posts');
                const container = document.getElementById('social-feed-container');

                postsRef.once('value', snapshot => { 
                    container.innerHTML = '';
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p id="no-posts-found">এখনো কোনো পোস্ট করা হয়নি।</p>';
                        return;
                    }
                    
                    const posts = [];
                    snapshot.forEach(childSnapshot => {
                        posts.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                    
                    shuffleArray(posts); // MODIFICATION: Shuffle the posts for random order
                    
                    posts.forEach(post => {
                        const postElement = createPostElement(post);
                        container.appendChild(postElement);
                    });
                });
            }

            function createPostElement(post) {
                const card = document.createElement('div');
                card.className = 'post-card';
                
                const visitorId = state.currentUser ? state.currentUser.mobile : getUniqueVisitorId();
                const isLiked = post.reacts && post.reacts[visitorId];
                
                const sanitizedCaption = (post.caption || '').replace(/"/g, '&quot;');

                card.innerHTML = `
                    <div class="post-header">
                        <div class="post-header-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        </div>
                        <div class="post-header-info">
                            <div class="name">${post.uploaderName || 'Unknown User'}</div>
                            <div class="id">User ID: ${post.uploaderId || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="post-image-container">
                        <img src="${post.imageUrl}" alt="Social post" loading="lazy">
                    </div>
                    <div class="post-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>
                        </button>
                        <button class="share-btn" data-post-id="${post.id}" data-caption="${sanitizedCaption}" data-short-id="${post.postIdShort}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                        </button>
                        <span class="like-count">${post.reactCount || 0} loves</span>
                    </div>
                    <div class="post-caption">
                        <span class="uploader-name">${post.uploaderName || ''}</span>
                        <span>${post.caption || ''}</span>
                        <span class="post-short-id">#${post.postIdShort || '00000'}</span>
                    </div>
                `;
                
                return card;
            }

            function handleLikeClick(e) {
                const button = e.currentTarget;
                const postId = button.dataset.postId;
                const likeCountSpan = button.parentElement.querySelector('.like-count');
                const visitorId = state.currentUser ? state.currentUser.mobile : getUniqueVisitorId();
                const postRef = database.ref(`social_posts/${postId}`);
                
                postRef.transaction(post => {
                    if (post) {
                        if (post.reacts && post.reacts[visitorId]) {
                            post.reactCount--;
                            post.reacts[visitorId] = null;
                        } else {
                            if (!post.reactCount) post.reactCount = 0;
                            post.reactCount++;
                            if (!post.reacts) post.reacts = {};
                            post.reacts[visitorId] = true;
                        }
                    }
                    return post;
                }, (error, committed, snapshot) => {
                    if (committed) {
                        const updatedPost = snapshot.val();
                        button.classList.toggle('liked', updatedPost.reacts && updatedPost.reacts[visitorId]);
                        likeCountSpan.textContent = `${updatedPost.reactCount || 0} loves`;
                    }
                });
            }
            
            async function handleShareClick(button) {
                const caption = button.dataset.caption;
                const shortId = button.dataset.shortId;
                const shareData = {
                    title: 'My Blood DonorBook',
                    text: `Check out this post on My Blood DonorBook: ${caption}\n\nPost ID: #${shortId}`,
                    url: window.location.href,
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        alert('Share feature is not supported on your browser.');
                    }
                } catch (err) {
                    console.error("Share failed:", err.message);
                }
            }
            
            document.getElementById('social-feed-container').addEventListener('click', function (e) {
                const likeBtn = e.target.closest('.like-btn');
                const shareBtn = e.target.closest('.share-btn');
                if (likeBtn) {
                    handleLikeClick({ currentTarget: likeBtn });
                } else if (shareBtn) {
                    handleShareClick(shareBtn);
                }
            });
            
            function setupFeedBackButton() {
                feedBackBtn.addEventListener('click', () => {
                    history.back();
                });
                 // MODIFICATION: Added event listener for the new refresh button
                document.getElementById('feed-refresh-btn').addEventListener('click', fetchAndRenderPosts);
            }
            // --- END: MODIFIED SOCIAL FEED LOGIC ---


            // --- START: MODIFIED Back Button and Navigation Logic ---
            function openSidebar() {
                if (sidebar.classList.contains('open')) return;
                sidebar.classList.add('open');
                overlay.classList.add('active');
                history.pushState({ sidebar: true }, '', '#sidebar');
            }

            window.addEventListener('popstate', (event) => {
                isNavigatingBack = true;
                const state = event.state || {};
                
                // Close any open overlays first
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                hideSocialFeed();

                if (state.page) {
                    if (state.page === 'social-feed') {
                        showSocialFeed();
                    } else {
                        showPage(state.page, true);
                    }
                } else {
                    // MODIFICATION: REMOVED Exit confirmation logic
                    // Default behavior: go to home page if no specific page is in state
                    showPage('home', true);
                }
                isNavigatingBack = false;
            });
            // --- END: MODIFIED Back Button Logic ---


            function initializeApp() {
                const savedTheme = localStorage.getItem('myBloodTheme') || 'light';
                applyTheme(savedTheme);
                createAnimatedBackground(); 
                showInitialAgreement();
                listenForAppUpdate();
                database.ref('users').on('value', (snapshot) => {
                    state.allUsers = snapshot.exists() ? Object.values(snapshot.val()) : [];
                    const loggedInUserMobile = localStorage.getItem('my_blood_currentUserMobile');
                    if (loggedInUserMobile) {
                        const user = state.allUsers.find(u => u.mobile === loggedInUserMobile);
                        if (user) { setCurrentUser(user); } else { handleLogout(); }
                    } else {
                        setCurrentUser(null);
                    }
                    updateUIForLoginState();
                });
                listenForAdminNotifications();
                loadMarqueeNotice();
                initializeBannerSlider();
                setupFeedBackButton(); 

                document.getElementById('gift-amount').addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
                
                history.replaceState({ page: 'home' }, '', '#home');
            }
            
            initializeApp();
        });
    </script>
</body>
</html>